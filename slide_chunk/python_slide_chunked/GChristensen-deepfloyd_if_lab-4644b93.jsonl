{"filename": "home/default/.jupyter/lab/jupyter_lab_config.py", "chunked_list": ["# Configuration file for lab.\nimport os\n\nREMOTE_ACCESS = os.getenv(\"IFLAB_REMOTE_ACCESS\")\n\nc = get_config()\n\nc.IdentityProvider.token = ''\nc.NotebookApp.token = ''\nc.PasswordIdentityProvider.password_required = False", "c.NotebookApp.token = ''\nc.PasswordIdentityProvider.password_required = False\nc.ExtensionApp.open_browser = False\nc.ServerApp.root_dir = \"notebooks\"\n\nif REMOTE_ACCESS and REMOTE_ACCESS != \"0\":\n    c.ServerApp.allow_origin = '*'\n    c.ServerApp.ip = '0.0.0.0'\n", ""]}
{"filename": "modules/ifui.py", "chunked_list": ["import sys\n\nfrom IPython.display import clear_output\nimport os\n\n\ndef unload_modules(of):\n    if_modules = []\n    for n, m in sys.modules.items():\n        if hasattr(m, \"__file__\") and m.__file__ and of in m.__file__:\n            if_modules.append(n)\n\n    for n in if_modules:\n        sys.modules.pop(n)", "\n\ndef show_ui():\n    global stages\n    print(\"Loading DeepFloyd IF Lab UI, please wait...\")\n\n    unload_modules(\"iflab\")\n\n    from iflab.pipelines.stages import DeepFloydIFStages\n    from iflab.ui.main import DeepFloydIFUI\n\n    try:\n        stages\n    except NameError:\n        stages = DeepFloydIFStages()\n        stages.load()\n\n    clear_output()\n\n    ui = DeepFloydIFUI(stages)\n    ui.show()\n\n    return ui", ""]}
{"filename": "modules/iflab/settings.py", "chunked_list": ["import os\n\nfrom easysettings import JSONSettings\n\nSETTINGS_FILE = \"../home/settings.json\"\n\nsettings = JSONSettings(filename=SETTINGS_FILE)\n\nif os.path.exists(SETTINGS_FILE):\n    settings.load()", "if os.path.exists(SETTINGS_FILE):\n    settings.load()\n"]}
{"filename": "modules/iflab/__init__.py", "chunked_list": ["from .const import *\nfrom .ui.open import open_ui\n"]}
{"filename": "modules/iflab/const.py", "chunked_list": ["import os\n\nVERSION = \"0.2.5\"\n\nDEBUG = os.getenv(\"IFLAB_DEBUG\", False)\nDEBUG = not not (DEBUG and DEBUG != \"0\")\nUI_THREADS = not DEBUG\nEXPERIMENTAL = os.getenv(\"IFLAB_EXPERIMENTAL\", False)\nEXPERIMENTAL = not not (EXPERIMENTAL and EXPERIMENTAL != \"0\")\n", "EXPERIMENTAL = not not (EXPERIMENTAL and EXPERIMENTAL != \"0\")\n\nSEQ_LOAD_OFF = \"off\"\nSEQ_LOAD_MERGE = \"merge\"\nSEQ_LOAD_SEPARATE = \"separate\"\n\nRESPACING_MODES = ['fast27', 'smart27', 'smart50', 'smart100', 'smart185', 'super27', 'super40', 'super100']\n\nDEBUG_PROMPT = \"ultra close-up color photo portrait of rainbow owl with deer horns in the woods\"\n\nif DEBUG:\n    PROMPT_FILE = \"../home/debug_prompt.txt\"\n    if os.path.exists(PROMPT_FILE):\n        with open(PROMPT_FILE, \"r\", encoding=\"utf-8\") as f:\n            DEBUG_PROMPT = f.read()", "DEBUG_PROMPT = \"ultra close-up color photo portrait of rainbow owl with deer horns in the woods\"\n\nif DEBUG:\n    PROMPT_FILE = \"../home/debug_prompt.txt\"\n    if os.path.exists(PROMPT_FILE):\n        with open(PROMPT_FILE, \"r\", encoding=\"utf-8\") as f:\n            DEBUG_PROMPT = f.read()\n\n", ""]}
{"filename": "modules/iflab/init.py", "chunked_list": ["import torch\nimport os\n\nfrom pathlib import Path\n\nfrom .const import SEQ_LOAD_OFF, SEQ_LOAD_MERGE, SEQ_LOAD_SEPARATE\nfrom .settings import settings\n\n\ndef get_total_gb_vram():\n    if torch.cuda.is_available():\n        return round(torch.cuda.get_device_properties(0).total_memory / 1024 ** 3)\n    else:\n        return 8", "\ndef get_total_gb_vram():\n    if torch.cuda.is_available():\n        return round(torch.cuda.get_device_properties(0).total_memory / 1024 ** 3)\n    else:\n        return 8\n\n\ndef apply_default_mem_settings():\n    total_gb_vram = get_total_gb_vram()\n\n    seq_load = settings.get(\"sequential_load\", None)\n\n    if not seq_load:\n        if total_gb_vram >= 24:\n            settings.set(\"sequential_load\", SEQ_LOAD_OFF)\n        elif total_gb_vram >= 12:\n            settings.set(\"sequential_load\", SEQ_LOAD_MERGE)\n        else:\n            settings.set(\"sequential_load\", SEQ_LOAD_SEPARATE)\n            settings.set(\"stageI_model\", \"IF-I-L-v1.0\")\n            settings.set(\"stageII_model\", \"IF-II-L-v1.0\")\n\n        settings.save()\n\n    return settings.get(\"sequential_load\")", "def apply_default_mem_settings():\n    total_gb_vram = get_total_gb_vram()\n\n    seq_load = settings.get(\"sequential_load\", None)\n\n    if not seq_load:\n        if total_gb_vram >= 24:\n            settings.set(\"sequential_load\", SEQ_LOAD_OFF)\n        elif total_gb_vram >= 12:\n            settings.set(\"sequential_load\", SEQ_LOAD_MERGE)\n        else:\n            settings.set(\"sequential_load\", SEQ_LOAD_SEPARATE)\n            settings.set(\"stageI_model\", \"IF-I-L-v1.0\")\n            settings.set(\"stageII_model\", \"IF-II-L-v1.0\")\n\n        settings.save()\n\n    return settings.get(\"sequential_load\")", "\n\ndef init_installation():\n    apply_default_mem_settings()\n\n"]}
{"filename": "modules/iflab/pipelines/dream.py", "chunked_list": ["from deepfloyd_if.pipelines.dream import dream\nfrom .pipeline import Pipeline\nfrom .. import EXPERIMENTAL\n\n\nclass DreamPipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.dream_mod(**kwargs)\n        else:\n            return dream(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference dream')\n            return self.experimental.dream_ref(**kwargs)\n        else:\n            return dream(**kwargs)\n\n    def modify_args(self, args):\n        args[\"aspect_ratio\"] = self.aspect_ratio"]}
{"filename": "modules/iflab/pipelines/pipeline.py", "chunked_list": ["import importlib\nimport time\nimport random\nimport traceback\n\nfrom abc import ABC, abstractmethod\nfrom collections import UserDict\nfrom dataclasses import dataclass\nfrom datetime import datetime\nfrom random import randint", "from datetime import datetime\nfrom random import randint\n\nimport numpy as np\nfrom torch import autocast\n\nfrom .stages import ModelError\nfrom .. import SEQ_LOAD_OFF, SEQ_LOAD_SEPARATE, DEBUG, SEQ_LOAD_MERGE\n\n", "\n\n@dataclass\nclass IFResult:\n    images: ...\n    tensors: ...\n    generations: ...\n    args: ...\n    seed: ...\n    time: ...\n    iterations: ...\n    duration: ...", "\n\nclass Pipeline(ABC):\n    def __init__(self, stages):\n        self.override_args = {}\n        self.settings = {}\n        self.stages = stages\n\n        self.count = 1\n\n        self.aspect_ratio = \"1:1\"\n        self.prompt = None\n        self.negative_prompt = None\n        self.style_prompt = None\n\n        self.t5_embs = None\n        self.negative_t5_embs = None\n        self.style_t5_embs = None\n\n        self.guidanceI = 7.0\n        self.stepsI = \"smart100\"\n        self.guidanceII = 4.0\n        self.stepsII = \"smart50\"\n        self.guidanceIII = 4.0\n        self.stepsIII = 75\n        self.noiseIII = 20\n\n        self.custom_paramsI = None\n        self.custom_paramsII = None\n        self.custom_paramsIII = None\n\n        self.iterationsI = 0\n        self.iterationsII = 0\n        self.iterationsIII = 0\n\n        self.result_stageI = None\n        self.result_upscale = None\n        self.generationsI = {}\n\n        self.support_image = None\n        self.mask_image = None\n        self.disable_watermark = False\n        self.pass_prompt_to_stage_III = None\n\n        self.on_before_embeddings = lambda: None\n        self.on_before_generation = lambda: None\n        self.on_before_upscale = lambda: None\n        self.on_before_checkpoints_loaded = lambda m: None\n        self.on_checkpoints_loaded = lambda: None\n\n        try:\n            self.experimental = importlib.import_module('.'.join(__name__.split('.')[:-1]) + \".experimental\")\n        except ImportError as e:\n            self.experimental = None\n\n    def prepare_embeddings(self):\n        if not self.stages.has_t5():\n            self.on_before_checkpoints_loaded(False)\n\n        self.stages.free_stageIII()\n        self.stages.free_stageII()\n        self.stages.free_stageI()\n\n        was_loaded = self.stages.ensure_t5()\n\n        if not self.has_t5_loaded:\n            raise ModelError(\"Error loading T5 encoder.\")\n\n        if was_loaded:\n            self.on_checkpoints_loaded()\n\n        self.on_before_embeddings()\n\n    def compute_t5_embs(self, update_prompt=True, update_negative=True, update_style=True):\n        self.prepare_embeddings()\n\n        if update_prompt:\n            if self.prompt is not None:\n                promptv = [self.prompt] * self.count\n                self.t5_embs = self.stages.t5.get_text_embeddings(promptv)\n            else:\n                self.t5_embs = None\n\n        if update_negative:\n            if self.negative_prompt is not None:\n                promptv = [self.negative_prompt] * self.count\n                self.negative_t5_embs = self.stages.t5.get_text_embeddings(promptv)\n            else:\n                self.negative_t5_embs = None\n\n        if update_style:\n            if self.style_prompt is not None:\n                promptv = [self.style_prompt] * self.count\n                self.style_t5_embs = self.stages.t5.get_text_embeddings(promptv)\n            else:\n                self.style_t5_embs = None\n\n    def generate_seed(self):\n        return randint(0, np.iinfo(np.int32).max)\n\n    def prepare_prompts(self):\n        prompt = [self.prompt] if isinstance(self.prompt, str) else self.prompt\n        negative = [self.negative_prompt] if isinstance(self.negative_prompt, str) else self.negative_prompt\n        style = [self.style_prompt] if isinstance(self.style_prompt, str) else self.style_prompt\n\n        return prompt, negative, style\n\n    def merge_args(self, args, override):\n        for k, v in override.items():\n            if (isinstance(v, dict) or isinstance(v, UserDict)) and k in args:\n                self.merge_args(args[k], v)\n            elif v is not None:\n                args[k] = v\n\n    def add_custom_parameters(self, stage_args, params):\n        if params and stage_args:\n            for k, v in params.items():\n                stage_args[k] = v\n\n    @property\n    def is_optimized(self):\n        return self.stages.sequential_load != SEQ_LOAD_OFF\n\n    @property\n    def has_t5_loaded(self):\n        return self.stages.has_t5()\n\n    @property\n    def has_stageI_loaded(self):\n        return self.stages.has_stageI()\n\n    @property\n    def has_stageII_loaded(self):\n        return self.stages.has_stageII()\n\n    @property\n    def has_stageIII_loaded(self):\n        return self.stages.has_stageIII()\n\n    def prepare_generation(self):\n        if not self.has_stageI_loaded:\n            self.on_before_checkpoints_loaded(not self.stages.downloaded_stageI())\n\n        self.stages.free_t5()\n        self.stages.free_stageII()\n        self.stages.free_stageIII()\n        was_loaded = self.stages.ensure_stageI()\n\n        if not self.has_stageI_loaded:\n            raise ModelError(\"Error loading stage I model.\")\n\n        if was_loaded:\n            self.on_checkpoints_loaded()\n\n        self.on_before_generation()\n\n    def generate(self, seed=None, progress=True, is_reference=False):\n        self.prepare_generation()\n\n        if seed is None:\n            seed = self.generate_seed()\n\n        prompt, negative, style = self.prepare_prompts()\n\n        if_I_kwargs = UserDict({\n            \"guidance_scale\": self.guidanceI,\n            \"sample_timestep_respacing\": self.stepsI\n        })\n        self.add_custom_parameters(if_I_kwargs, self.custom_paramsI)\n\n        if prompt:\n            if_I_kwargs[\"t5_embs\"] = self.t5_embs\n        if negative:\n            if_I_kwargs[\"negative_t5_embs\"] = self.negative_t5_embs\n        if style:\n            if_I_kwargs[\"style_t5_embs\"] = self.style_t5_embs\n\n        kwargs = dict(\n            t5=self.stages.t5, if_I=self.stages.if_I,\n            prompt=prompt,\n            negative_prompt=negative,\n            style_prompt=style,\n            disable_watermark=self.disable_watermark,\n            seed=seed,\n            if_I_kwargs=if_I_kwargs,\n            return_tensors=True,\n            progress=progress\n        )\n\n        self.modify_args(kwargs)\n        self.merge_args(kwargs, self.override_args)\n        seed = kwargs[\"seed\"]\n\n        time_start = time.perf_counter()\n\n        invoke = self.invoke_ref if is_reference else self.invoke\n        self.result_stageI = invoke(**kwargs)\n\n        duration = time.perf_counter() - time_start\n        its = self.iterationsI / duration\n\n        images, tensors = self.result_stageI\n        output = images.get(\"output\", [[]])\n        self.result_stageI = IFResult(images, tensors, output, if_I_kwargs, seed, time.time(), its, duration)\n        self.generationsI[seed] = self.result_stageI\n\n        return self.result_stageI\n\n    def prepare_upscale(self, stage):\n        if not self.stages.has_stageII() or not self.stages.has_stageIII():\n            missing = stage == \"II\" and not self.stages.downloaded_stageII() or \\\n                      stage == \"III\" and not self.stages.downloaded_stageIII()\n\n            self.on_before_checkpoints_loaded(missing)\n\n        self.stages.free_t5()\n        self.stages.free_stageI()\n\n        was_loaded = False\n        if stage == \"II\":\n            if self.stages.sequential_load == SEQ_LOAD_SEPARATE and self.has_stageIII_loaded:\n                self.stages.free_stageIII()\n\n            was_loaded = self.stages.ensure_stageII()\n\n            if not self.has_stageII_loaded:\n                raise ModelError(\"Error loading stage II model.\")\n\n        if stage == \"III\" or self.stages.sequential_load == SEQ_LOAD_MERGE:\n            if self.stages.sequential_load == SEQ_LOAD_SEPARATE and self.has_stageII_loaded:\n                self.stages.free_stageII()\n\n            try:\n                was_loaded = self.stages.ensure_stageIII() or was_loaded\n            except Exception as e:\n                if DEBUG:\n                    traceback.print_exc()\n\n            if not self.has_stageIII_loaded:\n                raise ModelError(\"Error loading stage III model.\")\n\n        if was_loaded:\n            self.on_checkpoints_loaded()\n\n        self.on_before_upscale()\n\n    def get_upscaleII_kwargs(self, resultI):\n        if_II_kwargs = UserDict({\n            \"guidance_scale\": self.guidanceII,\n            \"sample_timestep_respacing\": self.stepsII\n        })\n        self.add_custom_parameters(if_II_kwargs, self.custom_paramsII)\n        # the usage of patched pipelines is assumed here, although technically it will work without the patch\n        # some extra parameters are passed as metadata to preserve the original interface\n        resultI.args.imagesI = resultI.images[\"I\"]\n        resultI.args.tensorsI = resultI.tensors[0]\n\n        return if_II_kwargs\n\n    def get_upscaleIII_kwargs(self, resultII):\n        if_III_kwargs = UserDict({\n            \"guidance_scale\": self.guidanceIII,\n            \"noise_level\": self.noiseIII,\n            \"sample_timestep_respacing\": str(self.stepsIII),\n        })\n        self.add_custom_parameters(if_III_kwargs, self.custom_paramsIII)\n\n        if_III_kwargs.imagesII = resultII.images[\"II\"]\n        if_III_kwargs.tensorsII = resultII.tensors[1]\n        if_III_kwargs.pass_prompt_to_sIII = self.pass_prompt_to_stage_III\n\n        return if_III_kwargs\n\n    def upscale(self, resultI=None, resultII=None, progress=False, is_reference=False):\n        stage = \"III\" if resultII else \"II\"\n\n        self.prepare_upscale(stage)\n\n        seed = resultI.seed\n        rtime = resultI.time\n        if_I_kwargs = resultI.args\n        if_II_kwargs = self.get_upscaleII_kwargs(resultI) if stage == \"II\" else None\n        if_III_kwargs = self.get_upscaleIII_kwargs(resultII) if stage == \"III\" else None\n        if_III = self.stages.if_III if stage == \"III\" else None\n        prompt, negative, style = self.prepare_prompts()\n\n        time_start = time.perf_counter()\n\n        kwargs = dict(\n            t5=self.stages.t5, if_I=self.stages.if_I, if_II=self.stages.if_II, if_III=if_III,\n            prompt=prompt,\n            negative_prompt=negative,\n            style_prompt=style,\n            disable_watermark=self.disable_watermark,\n            seed=seed,\n            if_I_kwargs=if_I_kwargs,\n            if_II_kwargs=if_II_kwargs,\n            if_III_kwargs=if_III_kwargs,\n            return_tensors=True,\n            progress=progress\n        )\n\n        self.modify_args(kwargs)\n        self.merge_args(kwargs, self.override_args)\n        seed = kwargs[\"seed\"]\n\n        invoke = self.invoke_ref if is_reference else self.invoke\n        self.result_upscale = invoke(**kwargs)\n\n        duration = time.perf_counter() - time_start\n\n        images, tensors = self.result_upscale\n        output = images.get(\"output\", [[]])\n        self.result_upscale = IFResult(images, tensors, output, if_II_kwargs, seed, rtime, 0, duration)\n\n        return self.result_upscale\n\n    @abstractmethod\n    def invoke(self, **kwargs):\n        pass\n\n    @abstractmethod\n    def invoke_ref(self, **kwargs):\n        pass\n\n    @abstractmethod\n    def modify_args(self, args):\n        pass"]}
{"filename": "modules/iflab/pipelines/__init__.py", "chunked_list": [""]}
{"filename": "modules/iflab/pipelines/utils.py", "chunked_list": ["import torch\n\ndef get_total_gb_vram():\n    if torch.cuda.is_available():\n        return round(torch.cuda.get_device_properties(0).total_memory / 1024 ** 3)\n    else:\n        return 0\n\n\ndef get_default_settings():\n    result = {}\n\n    total_gb_vram = get_total_gb_vram()\n\n    if total_gb_vram >= 24:\n        result = {\"alternate_load\": False}\n    elif total_gb_vram >= 12:\n        result = {\n            \"alternate_load\": True\n        }\n    else:\n        result = {\n            \"stageI_model\": \"IF-I-L-v1.0\",\n            \"stageII_model\": \"IF-II-M-v1.0\",\n            \"alternate_load\": True\n        }\n\n    return result", "\ndef get_default_settings():\n    result = {}\n\n    total_gb_vram = get_total_gb_vram()\n\n    if total_gb_vram >= 24:\n        result = {\"alternate_load\": False}\n    elif total_gb_vram >= 12:\n        result = {\n            \"alternate_load\": True\n        }\n    else:\n        result = {\n            \"stageI_model\": \"IF-I-L-v1.0\",\n            \"stageII_model\": \"IF-II-M-v1.0\",\n            \"alternate_load\": True\n        }\n\n    return result", ""]}
{"filename": "modules/iflab/pipelines/style_transfer.py", "chunked_list": ["from deepfloyd_if.pipelines import style_transfer\nfrom deepfloyd_if.pipelines.utils import _prepare_pil_image\n\nfrom .pipeline import Pipeline, IFResult\nfrom .stages import ModelError\nfrom .. import EXPERIMENTAL, SEQ_LOAD_OFF\n\n\nclass StylePipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsI = {\"sample_timestep_respacing\": \"10,10,10,10,10,10,10,10,0,0\",\n                               \"support_noise_less_qsample_steps\": 5}\n        self.custom_paramsII = {\"support_noise_less_qsample_steps\": 5}\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.style_transfer_mod(**kwargs)\n        else:\n            return style_transfer(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference style_transfer')\n            return self.experimental.style_transfer_ref(**kwargs)\n        else:\n            return style_transfer(**kwargs)\n\n    def modify_args(self, args):\n        args[\"support_pil_img\"] = self.support_image\n        # TODO: move support images to the class level in all pipelines for optimization\n        args[\"if_I_kwargs\"].low_res = _prepare_pil_image(self.support_image, 64)\n        args[\"if_I_kwargs\"].mid_res = _prepare_pil_image(self.support_image, 256)", "class StylePipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsI = {\"sample_timestep_respacing\": \"10,10,10,10,10,10,10,10,0,0\",\n                               \"support_noise_less_qsample_steps\": 5}\n        self.custom_paramsII = {\"support_noise_less_qsample_steps\": 5}\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.style_transfer_mod(**kwargs)\n        else:\n            return style_transfer(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference style_transfer')\n            return self.experimental.style_transfer_ref(**kwargs)\n        else:\n            return style_transfer(**kwargs)\n\n    def modify_args(self, args):\n        args[\"support_pil_img\"] = self.support_image\n        # TODO: move support images to the class level in all pipelines for optimization\n        args[\"if_I_kwargs\"].low_res = _prepare_pil_image(self.support_image, 64)\n        args[\"if_I_kwargs\"].mid_res = _prepare_pil_image(self.support_image, 256)", ""]}
{"filename": "modules/iflab/pipelines/inpainting.py", "chunked_list": ["import numpy as np\nfrom PIL import Image\n\nfrom deepfloyd_if.pipelines import inpainting\nfrom deepfloyd_if.pipelines.utils import _prepare_pil_image\n\nfrom .pipeline import Pipeline\nfrom .. import EXPERIMENTAL\n\n\nclass InpaintingPipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsI = {\"sample_timestep_respacing\": \"10,10,10,10,10,0,0,0,0,0\",\n                               \"support_noise_less_qsample_steps\": 0}\n        self.custom_paramsII = {\"aug_level\": 0.0}\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.inpainting_mod(**kwargs)\n        else:\n            return inpainting(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference inpainting')\n            return self.experimental.inpainting_ref(**kwargs)\n        else:\n            return inpainting(**kwargs)\n\n    def modify_args(self, args):\n        del args[\"style_prompt\"]\n        if hasattr(args[\"if_I_kwargs\"], 'style_t5_embs'):\n            del args[\"if_I_kwargs\"]['style_t5_embs']\n\n        if self.support_image:\n            args[\"support_pil_img\"] = self.support_image\n\n            inpainting_mask = None\n            if self.mask_image:\n                inpainting_mask = np.array(self.mask_image)\n            else:\n                blank_pil_image = Image.new('RGB', self.support_image.size, (255, 255, 255))\n                inpainting_mask = np.array(blank_pil_image)\n\n            inpainting_mask = np.moveaxis(inpainting_mask, -1, 0)\n\n            args['inpainting_mask'] = inpainting_mask\n\n            args[\"if_I_kwargs\"].low_res = _prepare_pil_image(self.support_image, 64)\n            args[\"if_I_kwargs\"].mid_res = _prepare_pil_image(self.support_image, 256)\n            args[\"if_I_kwargs\"].high_res = _prepare_pil_image(self.support_image, 1024)", "\n\nclass InpaintingPipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsI = {\"sample_timestep_respacing\": \"10,10,10,10,10,0,0,0,0,0\",\n                               \"support_noise_less_qsample_steps\": 0}\n        self.custom_paramsII = {\"aug_level\": 0.0}\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.inpainting_mod(**kwargs)\n        else:\n            return inpainting(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference inpainting')\n            return self.experimental.inpainting_ref(**kwargs)\n        else:\n            return inpainting(**kwargs)\n\n    def modify_args(self, args):\n        del args[\"style_prompt\"]\n        if hasattr(args[\"if_I_kwargs\"], 'style_t5_embs'):\n            del args[\"if_I_kwargs\"]['style_t5_embs']\n\n        if self.support_image:\n            args[\"support_pil_img\"] = self.support_image\n\n            inpainting_mask = None\n            if self.mask_image:\n                inpainting_mask = np.array(self.mask_image)\n            else:\n                blank_pil_image = Image.new('RGB', self.support_image.size, (255, 255, 255))\n                inpainting_mask = np.array(blank_pil_image)\n\n            inpainting_mask = np.moveaxis(inpainting_mask, -1, 0)\n\n            args['inpainting_mask'] = inpainting_mask\n\n            args[\"if_I_kwargs\"].low_res = _prepare_pil_image(self.support_image, 64)\n            args[\"if_I_kwargs\"].mid_res = _prepare_pil_image(self.support_image, 256)\n            args[\"if_I_kwargs\"].high_res = _prepare_pil_image(self.support_image, 1024)", "\n"]}
{"filename": "modules/iflab/pipelines/stages.py", "chunked_list": ["import gc\nimport importlib\nimport os\nimport sys\nimport time\nimport traceback\n\nimport torch\n\nfrom huggingface_hub import notebook_login, login", "\nfrom huggingface_hub import notebook_login, login\nfrom deepfloyd_if.modules.t5 import T5Embedder\nfrom deepfloyd_if.modules import IFStageI, IFStageII, StableStageIII\n\nfrom .. import SEQ_LOAD_OFF, SEQ_LOAD_SEPARATE\nfrom ..const import EXPERIMENTAL, DEBUG\nfrom ..init import apply_default_mem_settings\nfrom ..settings import settings\n\nif sys.platform == \"darwin\":\n    from . import mac", "from ..settings import settings\n\nif sys.platform == \"darwin\":\n    from . import mac\n\nIFLAB_HOME = os.getenv(\"IFLAB_HOME\")\nLOGGED_IN_HF = os.path.exists(os.path.join(IFLAB_HOME, \"home\", \"huggingface\", \"token\"))\n\nDEFAULT_MODEL_T5 = \"t5-v1_1-xxl\"\nDEFAULT_MODEL_I = \"IF-I-XL-v1.0\"", "DEFAULT_MODEL_T5 = \"t5-v1_1-xxl\"\nDEFAULT_MODEL_I = \"IF-I-XL-v1.0\"\nDEFAULT_MODEL_II = \"IF-II-L-v1.0\"\nDEFAULT_MODEL_III = \"stable-diffusion-x4-upscaler\"\n\nif EXPERIMENTAL:\n    try:\n        experimental_module = importlib.import_module('.'.join(__name__.split('.')[:-1]) + \".experimental\")\n    except ImportError as e:\n        experimental_module = None\n    ModIFStageI = experimental_module.ModIFStageI\n    ModIFStageII = experimental_module.ModIFStageII\n    ModIFStageIII = experimental_module.ModIFStageIII\nelse:\n    ModIFStageI = IFStageI\n    ModIFStageII = IFStageII\n    ModIFStageIII = StableStageIII", "\n\nclass ModelError(Exception):\n    pass\n\ndef get_t5_device_map(device):\n    return {\n        'shared': device,\n        'encoder.embed_tokens': device,\n        'encoder.block.0': device,\n        'encoder.block.1': device,\n        'encoder.block.2': device,\n        'encoder.block.3': device,\n        'encoder.block.4': device,\n        'encoder.block.5': device,\n        'encoder.block.6': device,\n        'encoder.block.7': device,\n        'encoder.block.8': device,\n        'encoder.block.9': device,\n        'encoder.block.10': 'cpu',\n        'encoder.block.11': 'cpu',\n        'encoder.block.12': 'cpu',\n        'encoder.block.13': 'cpu',\n        'encoder.block.14': 'cpu',\n        'encoder.block.15': 'cpu',\n        'encoder.block.16': 'cpu',\n        'encoder.block.17': 'cpu',\n        'encoder.block.18': 'cpu',\n        'encoder.block.19': 'cpu',\n        'encoder.block.20': 'cpu',\n        'encoder.block.21': 'cpu',\n        'encoder.block.22': 'cpu',\n        'encoder.block.23': 'cpu',\n        'encoder.final_layer_norm': 'cpu',\n        'encoder.dropout': 'cpu',\n    }", "\n\ndef offload_to_disk(device_map):\n    device_map = device_map.copy()\n\n    for k, v in device_map.items():\n        if v == \"cpu\":\n            device_map[k] = \"disk\"\n\n    return device_map", "\nclass DeepFloydIFStages:\n    def __init__(self):\n        self.device = os.getenv(\"IFLAB_DEVICE\", \"cuda:0\")\n\n        if sys.platform == \"darwin\":\n            self.device = \"mps\"\n\n        self.t5 = None\n        self.t5_on_gpu = False\n        self.if_I = None\n        self.if_II = None\n        self.if_III = None\n\n        self.sequential_load = settings.get(\"sequential_load\", None)\n\n        if self.sequential_load is None:\n            self.sequential_load = apply_default_mem_settings()\n\n        self.t5_model_name = DEFAULT_MODEL_T5\n        self.t5_dtype = \"bfloat16\" if os.getenv(\"IFLAB_T5_DTYPE\", \"float32\").lower() == \"bfloat16\" else \"float32\"\n        self.stageI_model_name = settings.get(\"stageI_model\", DEFAULT_MODEL_I)\n        self.stageII_model_name = settings.get(\"stageII_model\", DEFAULT_MODEL_II)\n        self.stageIII_model_name = settings.get(\"stageIII_model\", DEFAULT_MODEL_III)\n        self.has_missing_models = False\n        self.loaded = False\n\n        vram_fraction = os.getenv(\"IFLAB_VRAM_FRACTION\", None)\n        if vram_fraction:\n            torch.cuda.set_per_process_memory_fraction(float(vram_fraction), self.device)\n\n    def load(self):\n        if not self.loaded:\n            if not LOGGED_IN_HF:\n                import pyperclip\n                hf_token = os.getenv(\"HF_TOKEN\") or pyperclip.paste()\n\n                if hf_token and hf_token.startswith(\"hf_\"):\n                    login(hf_token)\n                else:\n                    notebook_login()\n\n            if os.getenv(\"IFLAB_INSTALL\", False):\n                self.ensure_t5()\n                self.ensure_stageI()\n                self.unload_stageI()\n                self.ensure_stageII()\n                self.unload_stageII()\n\n                try:  # may raise error just after it was downloaded from HF\n                    self.load_stageIII()\n                except:\n                    try:\n                        time.sleep(.5)\n                        self.load_stageIII()\n                    except:\n                        traceback.print_exc()\n                self.unload_stageIII()\n            else:\n                self.has_missing_models = (not self.downloaded_t5() or not self.downloaded_stageI()\n                                           or not self.downloaded_stageII() or not self.downloaded_stageIII())\n\n            self.loaded = True\n\n    def load_t5(self):\n        try:\n            t5_dtype = torch.bfloat16 if self.t5_dtype == \"bfloat16\" else torch.float32\n            t5_model_kwargs = None\n            t5_device = \"cpu\"\n\n            if os.getenv(\"IFLAB_T5_ON_GPU\", False):\n                self.t5_on_gpu = True\n                t5_device = self.device\n                t5_device_map = get_t5_device_map(t5_device)\n\n                if os.getenv(\"IFLAB_LOWRAM\", False):\n                    t5_device_map = offload_to_disk(t5_device_map)\n\n                t5_model_kwargs = {\"low_cpu_mem_usage\": True,\n                                   \"device_map\": t5_device_map,\n                                   \"offload_folder\": \"../home/t5-offload\"}\n\n            self.t5 = T5Embedder(device=t5_device, torch_dtype=t5_dtype, t5_model_kwargs=t5_model_kwargs)\n        except:\n            if DEBUG:\n                traceback.print_exc()\n\n    def has_t5(self):\n        return not not self.t5\n\n    def downloaded_t5(self):\n        return self.if_stage_exists(self.t5_model_name)\n\n    def ensure_t5(self):\n        result = bool(self.t5)\n        if not self.t5:\n            self.load_t5()\n        return result\n\n    def unload_t5(self, empty_cache=True):\n        if self.t5:\n            self.unload_stage(\"t5\", empty_cache=empty_cache)\n\n    def free_t5(self, empty_cache=True):\n        if self.t5_on_gpu:\n            self.unload_t5(empty_cache=empty_cache)\n\n    def load_stageI(self):\n        try:\n            self.if_I = ModIFStageI(self.stageI_model_name, device=self.device)\n            return self.if_I\n        except:\n            traceback.print_exc()\n\n    def has_stageI(self):\n        current_stageI = settings.get(\"stageI_model\", DEFAULT_MODEL_I)\n\n        if current_stageI != self.stageI_model_name:\n            self.stageI_model_name = current_stageI\n            self.unload_stageI()\n\n        return not not self.if_I\n\n    def downloaded_stageI(self):\n        return self.if_stage_exists(self.stageI_model_name)\n\n    def if_stage_exists(self, model_name):\n        return os.path.exists(f\"../home/.cache/IF_/{model_name}\")\n\n    def ensure_stageI(self):\n        result = bool(self.if_I)\n        if not self.if_I:\n            self.load_stageI()\n        return result\n\n    def unload_stageI(self, empty_cache=True):\n        if self.if_I:\n            self.unload_stage(\"if_I\", empty_cache=empty_cache)\n\n    def unload_stage(self, stage, empty_cache=True):\n        try:\n            getattr(self, stage).model.to(\"cpu\")\n        except:\n            if DEBUG:\n                traceback.print_exc()\n\n        setattr(self, stage, None)\n        if empty_cache:\n            gc.collect()\n            torch.cuda.empty_cache()\n            torch.cuda.synchronize()\n\n    def free_stageI(self, empty_cache=True):\n        if self.sequential_load != SEQ_LOAD_OFF:\n            self.unload_stageI(empty_cache=empty_cache)\n\n    def load_stageII(self):\n        try:\n            self.if_II = ModIFStageII(self.stageII_model_name, device=self.device)\n            return self.if_II\n        except:\n            traceback.print_exc()\n\n    def has_stageII(self):\n        current_stageII = settings.get(\"stageII_model\", DEFAULT_MODEL_II)\n\n        if current_stageII != self.stageII_model_name:\n            self.stageII_model_name = current_stageII\n            self.unload_stageII()\n\n        return not not self.if_II\n\n    def downloaded_stageII(self):\n        return self.if_stage_exists(self.stageII_model_name)\n\n    def ensure_stageII(self):\n        result = bool(self.if_II)\n        if not self.if_II:\n            self.load_stageII()\n        return result\n\n    def free_stageII(self, empty_cache=True):\n        if self.sequential_load != SEQ_LOAD_OFF:\n            self.unload_stageII(empty_cache=empty_cache)\n\n    def unload_stageII(self, empty_cache=True):\n        if self.if_II:\n            self.unload_stage(\"if_II\", empty_cache=empty_cache)\n\n    def load_stageIII(self):\n        separate = self.sequential_load == SEQ_LOAD_SEPARATE\n        kwargs = None\n\n        if separate:\n            kwargs = {\"precision\": \"16\"}\n\n        self.if_III = ModIFStageIII(self.stageIII_model_name, device=self.device, model_kwargs=kwargs)\n\n        if separate:\n            self.if_III.model.enable_sequential_cpu_offload()\n\n        return self.if_III\n\n    def has_stageIII(self):\n        current_stageIII = settings.get(\"stageIII_model\", DEFAULT_MODEL_III)\n\n        if current_stageIII != self.stageIII_model_name:\n            self.stageIII_model_name = current_stageIII\n            self.unload_stageIII()\n\n        return not not self.if_III\n\n    def downloaded_stageIII(self):\n        if self.stageIII_model_name.startswith(\"IF\"):\n            return self.if_stage_exists(self.stageIII_model_name)\n        else:\n            return os.path.exists(\"../home/huggingface/hub/models--stabilityai--stable-diffusion-x4-upscaler/snapshots\")\n\n    def ensure_stageIII(self):\n        result = bool(self.if_III)\n        if not self.if_III:\n            self.load_stageIII()\n        return result\n\n    def unload_stageIII(self, empty_cache=True):\n        if self.if_III:\n            self.unload_stage(\"if_III\", empty_cache=empty_cache)\n\n    def free_stageIII(self, empty_cache=True):\n        if self.sequential_load != SEQ_LOAD_OFF:\n            self.unload_stageIII(empty_cache=empty_cache)", ""]}
{"filename": "modules/iflab/pipelines/super_resolution.py", "chunked_list": ["import time\nfrom abc import ABC\nfrom collections import UserDict\n\nfrom deepfloyd_if.pipelines import super_resolution\nfrom .pipeline import Pipeline, IFResult\nfrom .stages import ModelError\nfrom .. import EXPERIMENTAL, SEQ_LOAD_SEPARATE\n\n\nclass SuperResolutionPipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsII = {\"aug_level\": 0.2}\n\n    def modify_args(self, args):\n        pass\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.super_resolution_mod(**kwargs)\n        else:\n            return super_resolution(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference super_resolution')\n            return self.experimental.super_resolution_ref(**kwargs)\n        else:\n            return super_resolution(**kwargs)\n\n    def generate(self, seed=None, progress=True, reference=False):\n        if self.stages.sequential_load == SEQ_LOAD_SEPARATE:\n            raise ModelError(\"Not implemented for I/II/III\")\n\n        self.prepare_upscale(\"II\")\n        self.prepare_upscale(\"III\")\n        self.on_before_generation()\n\n        if seed is None:\n            seed = self.generate_seed()\n\n        if_II_kwargs = UserDict({\n            'sample_timestep_respacing': self.stepsII,\n            'guidance_scale': self.guidanceII,\n        })\n        self.add_custom_parameters(if_II_kwargs, self.custom_paramsII)\n        if_II_kwargs.t5_embs = self.t5_embs\n        if_II_kwargs.negative_t5_embs = self.negative_t5_embs\n\n        if_III_kwargs = {\n            \"guidance_scale\": self.guidanceIII,\n            \"noise_level\": self.noiseIII,\n            \"sample_timestep_respacing\": str(self.stepsIII),\n        }\n\n        kwargs = dict(\n            t5=self.stages.t5,\n            if_III=self.stages.if_II,\n            support_pil_img=self.support_image,\n            img_scale=4.,\n            img_size=64,\n            disable_watermark=self.disable_watermark,\n            progress=progress,\n            seed=seed,\n            if_III_kwargs=if_II_kwargs\n        )\n\n        prompt, negative, _ = self.prepare_prompts()\n\n        if prompt:\n            kwargs[\"prompt\"] = prompt\n        if negative:\n            kwargs[\"negative_prompt\"] = negative\n\n        self.merge_args(kwargs, self.override_args)\n        seed = kwargs[\"seed\"]\n\n        time_start = time.perf_counter()\n        invoke = self.invoke_ref if reference else self.invoke\n        middle_res = invoke(\n            **kwargs\n        )\n\n        self.on_before_upscale()\n\n        self.result_upscale = invoke(\n            t5=self.stages.t5,\n            if_III=self.stages.if_III,\n            prompt=[''],\n            support_pil_img=middle_res['III'][0],\n            img_scale=4.,\n            img_size=256,\n            disable_watermark=self.disable_watermark,\n            progress=progress,\n            seed=seed,\n            return_tensors=True,\n            if_III_kwargs=if_III_kwargs\n        )\n\n        duration = time.perf_counter() - time_start\n\n        images, tensors = self.result_upscale\n        output = images[\"output\"]\n        self.result_upscale = IFResult(images, tensors, output, None, seed, time.time(), 0, duration)\n        return self.result_upscale", "\n\nclass SuperResolutionPipeline(Pipeline):\n    def __init__(self, stages):\n        super().__init__(stages)\n\n        self.custom_paramsII = {\"aug_level\": 0.2}\n\n    def modify_args(self, args):\n        pass\n\n    def invoke(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            return self.experimental.super_resolution_mod(**kwargs)\n        else:\n            return super_resolution(**kwargs)\n\n    def invoke_ref(self, **kwargs):\n        if EXPERIMENTAL and self.experimental:\n            print('reference super_resolution')\n            return self.experimental.super_resolution_ref(**kwargs)\n        else:\n            return super_resolution(**kwargs)\n\n    def generate(self, seed=None, progress=True, reference=False):\n        if self.stages.sequential_load == SEQ_LOAD_SEPARATE:\n            raise ModelError(\"Not implemented for I/II/III\")\n\n        self.prepare_upscale(\"II\")\n        self.prepare_upscale(\"III\")\n        self.on_before_generation()\n\n        if seed is None:\n            seed = self.generate_seed()\n\n        if_II_kwargs = UserDict({\n            'sample_timestep_respacing': self.stepsII,\n            'guidance_scale': self.guidanceII,\n        })\n        self.add_custom_parameters(if_II_kwargs, self.custom_paramsII)\n        if_II_kwargs.t5_embs = self.t5_embs\n        if_II_kwargs.negative_t5_embs = self.negative_t5_embs\n\n        if_III_kwargs = {\n            \"guidance_scale\": self.guidanceIII,\n            \"noise_level\": self.noiseIII,\n            \"sample_timestep_respacing\": str(self.stepsIII),\n        }\n\n        kwargs = dict(\n            t5=self.stages.t5,\n            if_III=self.stages.if_II,\n            support_pil_img=self.support_image,\n            img_scale=4.,\n            img_size=64,\n            disable_watermark=self.disable_watermark,\n            progress=progress,\n            seed=seed,\n            if_III_kwargs=if_II_kwargs\n        )\n\n        prompt, negative, _ = self.prepare_prompts()\n\n        if prompt:\n            kwargs[\"prompt\"] = prompt\n        if negative:\n            kwargs[\"negative_prompt\"] = negative\n\n        self.merge_args(kwargs, self.override_args)\n        seed = kwargs[\"seed\"]\n\n        time_start = time.perf_counter()\n        invoke = self.invoke_ref if reference else self.invoke\n        middle_res = invoke(\n            **kwargs\n        )\n\n        self.on_before_upscale()\n\n        self.result_upscale = invoke(\n            t5=self.stages.t5,\n            if_III=self.stages.if_III,\n            prompt=[''],\n            support_pil_img=middle_res['III'][0],\n            img_scale=4.,\n            img_size=256,\n            disable_watermark=self.disable_watermark,\n            progress=progress,\n            seed=seed,\n            return_tensors=True,\n            if_III_kwargs=if_III_kwargs\n        )\n\n        duration = time.perf_counter() - time_start\n\n        images, tensors = self.result_upscale\n        output = images[\"output\"]\n        self.result_upscale = IFResult(images, tensors, output, None, seed, time.time(), 0, duration)\n        return self.result_upscale", ""]}
{"filename": "modules/iflab/pipelines/mac/__init__.py", "chunked_list": ["# mac support stub\n# Please see https://github.com/GChristensen/deepfloyd_if_lab_mac/"]}
{"filename": "modules/iflab/ui/pnginfo.py", "chunked_list": ["import weakref\n\nimport ipywidgets as widgets\nfrom ipywidgets import HBox, Layout\n\nfrom .pipeline import PipelineUI, catch_handler_errors\n\n\nclass PNGInfoUI(PipelineUI):\n    def __init__(self, uis, tabs):\n        super().__init__(None)\n        self.uis = [weakref.ref(ui) for ui in uis]\n        self.tabs = tabs\n\n    def _tune_ui(self):\n        self.upload_support_img_button.layout.display = \"none\"\n        self.send_to_label = widgets.Label(\"Send to:\")\n        self.dream_button = widgets.Button(description='Dream')\n        self.dream_button.on_click(self.send_pnginfo)\n        self.style_button = widgets.Button(description='Style Transfer')\n        self.style_button.on_click(self.send_pnginfo)\n        self.sr_button = widgets.Button(description='Super Resolution')\n        self.sr_button.on_click(self.send_pnginfo)\n        self.inpainting_button = widgets.Button(description='Inpainting')\n        self.inpainting_button.on_click(self.send_pnginfo)\n        self.spacer = HBox(layout=Layout(flex=\"1 0 auto\"))\n        self.pnginfo_button = widgets.FileUpload(\n            description='PNG Info',\n            accept='.png',\n            multiple=False,\n            tooltip='Load PNG Info from image'\n        )\n        self.pnginfo_button.observe(self.load_pnginfo_image)\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        self.button_box.children = [self.send_to_label, self.dream_button, self.style_button, self.sr_button,\n                                    self.inpainting_button, spacer, self.pnginfo_button]\n        self.paste_support_img_button.layout.display = \"none\"\n        self.info_button.tooltip = \"Browse PNGInfo\"\n\n    def on_display_info(self, button):\n        pass\n\n    def load_pnginfo_image(self, e):\n        self.load_support_image(e)\n        self.load_pnginfo(e)\n\n    def send_pnginfo(self, button):\n        for i, c in enumerate(self.button_box.children):\n            if c is button:\n                ui = self.uis[i - 1]()\n                parameters = self.get_ui_parameters()\n                ui.set_ui_parameters(parameters)\n                self.tabs.selected_index = i - 1\n                break\n\n    def get_title(self):\n        return \"PNG Info\"", "class PNGInfoUI(PipelineUI):\n    def __init__(self, uis, tabs):\n        super().__init__(None)\n        self.uis = [weakref.ref(ui) for ui in uis]\n        self.tabs = tabs\n\n    def _tune_ui(self):\n        self.upload_support_img_button.layout.display = \"none\"\n        self.send_to_label = widgets.Label(\"Send to:\")\n        self.dream_button = widgets.Button(description='Dream')\n        self.dream_button.on_click(self.send_pnginfo)\n        self.style_button = widgets.Button(description='Style Transfer')\n        self.style_button.on_click(self.send_pnginfo)\n        self.sr_button = widgets.Button(description='Super Resolution')\n        self.sr_button.on_click(self.send_pnginfo)\n        self.inpainting_button = widgets.Button(description='Inpainting')\n        self.inpainting_button.on_click(self.send_pnginfo)\n        self.spacer = HBox(layout=Layout(flex=\"1 0 auto\"))\n        self.pnginfo_button = widgets.FileUpload(\n            description='PNG Info',\n            accept='.png',\n            multiple=False,\n            tooltip='Load PNG Info from image'\n        )\n        self.pnginfo_button.observe(self.load_pnginfo_image)\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        self.button_box.children = [self.send_to_label, self.dream_button, self.style_button, self.sr_button,\n                                    self.inpainting_button, spacer, self.pnginfo_button]\n        self.paste_support_img_button.layout.display = \"none\"\n        self.info_button.tooltip = \"Browse PNGInfo\"\n\n    def on_display_info(self, button):\n        pass\n\n    def load_pnginfo_image(self, e):\n        self.load_support_image(e)\n        self.load_pnginfo(e)\n\n    def send_pnginfo(self, button):\n        for i, c in enumerate(self.button_box.children):\n            if c is button:\n                ui = self.uis[i - 1]()\n                parameters = self.get_ui_parameters()\n                ui.set_ui_parameters(parameters)\n                self.tabs.selected_index = i - 1\n                break\n\n    def get_title(self):\n        return \"PNG Info\"", ""]}
{"filename": "modules/iflab/ui/settings.py", "chunked_list": ["import json\n\nimport ipywidgets as widgets\nfrom ipywidgets import VBox, Layout\n\nfrom ..settings import settings\n\n\nclass SettingsUI():\n    def __init__(self, uis):\n        self.uis = uis\n\n        models_label = widgets.Label(\"\u00a0Models\", style=dict(background=\"var(--jp-layout-color2)\"))\n\n        self.stageI_model_dropdown = widgets.Dropdown(\n            options=['IF-I-XL-v1.0', 'IF-I-L-v1.0', 'IF-I-M-v1.0'],\n            value='IF-I-XL-v1.0',\n            description='Stage I: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageI_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageI_model_dropdown.__setting = \"stageI_model\"\n        self.stageI_model_dropdown.value = settings.get(self.stageI_model_dropdown.__setting,\n                                                        self.stageI_model_dropdown.options[0])\n        self.stageII_model_dropdown = widgets.Dropdown(\n            options=['IF-II-L-v1.0', 'IF-II-M-v1.0'],\n            value='IF-II-L-v1.0',\n            description='Stage II: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageII_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageII_model_dropdown.__setting = \"stageII_model\"\n        self.stageII_model_dropdown.value = settings.get(self.stageII_model_dropdown.__setting,\n                                                         self.stageII_model_dropdown.options[0])\n        self.stageIII_model_dropdown = widgets.Dropdown(\n            options=['stable-diffusion-x4-upscaler', 'IF-III-L-v1.0'],\n            value='stable-diffusion-x4-upscaler',\n            description='Stage III: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageIII_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageIII_model_dropdown.__setting = \"stageIII_model\"\n        self.stageIII_model_dropdown.value = settings.get(self.stageIII_model_dropdown.__setting,\n                                                          self.stageIII_model_dropdown.options[0])\n\n        self.sequential_loading_dropdown = widgets.Dropdown(\n            options=[('I+II+III (24GB)', 'off',), ('I/II+III (12GB)', 'merge'), ('I/II/III (8GB)', 'separate')],\n            value='separate',\n            description='Layout: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.sequential_loading_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.sequential_loading_dropdown.__setting = \"sequential_load\"\n        self.sequential_loading_dropdown.value = settings.get(self.sequential_loading_dropdown.__setting,\n                                                              self.sequential_loading_dropdown.options[2][1])\n\n        generation_label = widgets.Label(\"\u00a0Generation\",\n                                         style=dict(background=\"var(--jp-layout-color2)\"))\n\n        self.disable_watermark_check = widgets.Checkbox(\n            description=\"Disable watermark\"\n        )\n        self.disable_watermark_check.observe(self.on_settings_changed, 'value', type='change')\n        self.disable_watermark_check.__setting = \"disable_watermark\"\n        self.disable_watermark_check.value = settings.get(self.disable_watermark_check.__setting, False)\n\n        ui_label = widgets.Label(\"\u00a0User Interface\",\n                                 style=dict(background=\"var(--jp-layout-color2)\"))\n        self.remember_ui_state_check = widgets.Checkbox(\n            description=\"Remember UI state\"\n        )\n        self.remember_ui_state_check.observe(self.on_settings_changed, 'value', type='change')\n        self.remember_ui_state_check.__setting = \"remember_ui_state\"\n        self.remember_ui_state_check.value = settings.get(self.remember_ui_state_check.__setting, False)\n\n        self.root_box = VBox([models_label,\n                              self.stageI_model_dropdown, self.stageII_model_dropdown,\n                              self.stageIII_model_dropdown,\n                              self.sequential_loading_dropdown,\n                              generation_label,\n                              self.disable_watermark_check,\n                              ui_label,\n                              self.remember_ui_state_check],\n                             layout=Layout(min_height=\"500px\"))\n\n    def get(self):\n        return self.root_box\n\n    def get_title(self):\n        return \"Settings\"\n\n    def load_settings(self):\n        settings.load()\n        self.notify_uis()\n\n    def on_settings_changed(self, e):\n        key = e.owner.__setting\n        value = e[\"new\"]\n\n        self.setting_action(key, value)\n\n        settings[key] = value\n        settings.save()\n        self.notify_uis()\n\n    def setting_action(self, key, value):\n        pass\n\n    def settings_changed(self, e):\n        pass\n\n    def notify_uis(self):\n        for ui in self.uis:\n            ui.settings_changed(settings)", "class SettingsUI():\n    def __init__(self, uis):\n        self.uis = uis\n\n        models_label = widgets.Label(\"\u00a0Models\", style=dict(background=\"var(--jp-layout-color2)\"))\n\n        self.stageI_model_dropdown = widgets.Dropdown(\n            options=['IF-I-XL-v1.0', 'IF-I-L-v1.0', 'IF-I-M-v1.0'],\n            value='IF-I-XL-v1.0',\n            description='Stage I: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageI_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageI_model_dropdown.__setting = \"stageI_model\"\n        self.stageI_model_dropdown.value = settings.get(self.stageI_model_dropdown.__setting,\n                                                        self.stageI_model_dropdown.options[0])\n        self.stageII_model_dropdown = widgets.Dropdown(\n            options=['IF-II-L-v1.0', 'IF-II-M-v1.0'],\n            value='IF-II-L-v1.0',\n            description='Stage II: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageII_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageII_model_dropdown.__setting = \"stageII_model\"\n        self.stageII_model_dropdown.value = settings.get(self.stageII_model_dropdown.__setting,\n                                                         self.stageII_model_dropdown.options[0])\n        self.stageIII_model_dropdown = widgets.Dropdown(\n            options=['stable-diffusion-x4-upscaler', 'IF-III-L-v1.0'],\n            value='stable-diffusion-x4-upscaler',\n            description='Stage III: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.stageIII_model_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.stageIII_model_dropdown.__setting = \"stageIII_model\"\n        self.stageIII_model_dropdown.value = settings.get(self.stageIII_model_dropdown.__setting,\n                                                          self.stageIII_model_dropdown.options[0])\n\n        self.sequential_loading_dropdown = widgets.Dropdown(\n            options=[('I+II+III (24GB)', 'off',), ('I/II+III (12GB)', 'merge'), ('I/II/III (8GB)', 'separate')],\n            value='separate',\n            description='Layout: ',\n            style= {'description_width': 'max-content'},\n            disabled=False,\n        )\n        self.sequential_loading_dropdown.observe(self.on_settings_changed, 'value', type='change')\n        self.sequential_loading_dropdown.__setting = \"sequential_load\"\n        self.sequential_loading_dropdown.value = settings.get(self.sequential_loading_dropdown.__setting,\n                                                              self.sequential_loading_dropdown.options[2][1])\n\n        generation_label = widgets.Label(\"\u00a0Generation\",\n                                         style=dict(background=\"var(--jp-layout-color2)\"))\n\n        self.disable_watermark_check = widgets.Checkbox(\n            description=\"Disable watermark\"\n        )\n        self.disable_watermark_check.observe(self.on_settings_changed, 'value', type='change')\n        self.disable_watermark_check.__setting = \"disable_watermark\"\n        self.disable_watermark_check.value = settings.get(self.disable_watermark_check.__setting, False)\n\n        ui_label = widgets.Label(\"\u00a0User Interface\",\n                                 style=dict(background=\"var(--jp-layout-color2)\"))\n        self.remember_ui_state_check = widgets.Checkbox(\n            description=\"Remember UI state\"\n        )\n        self.remember_ui_state_check.observe(self.on_settings_changed, 'value', type='change')\n        self.remember_ui_state_check.__setting = \"remember_ui_state\"\n        self.remember_ui_state_check.value = settings.get(self.remember_ui_state_check.__setting, False)\n\n        self.root_box = VBox([models_label,\n                              self.stageI_model_dropdown, self.stageII_model_dropdown,\n                              self.stageIII_model_dropdown,\n                              self.sequential_loading_dropdown,\n                              generation_label,\n                              self.disable_watermark_check,\n                              ui_label,\n                              self.remember_ui_state_check],\n                             layout=Layout(min_height=\"500px\"))\n\n    def get(self):\n        return self.root_box\n\n    def get_title(self):\n        return \"Settings\"\n\n    def load_settings(self):\n        settings.load()\n        self.notify_uis()\n\n    def on_settings_changed(self, e):\n        key = e.owner.__setting\n        value = e[\"new\"]\n\n        self.setting_action(key, value)\n\n        settings[key] = value\n        settings.save()\n        self.notify_uis()\n\n    def setting_action(self, key, value):\n        pass\n\n    def settings_changed(self, e):\n        pass\n\n    def notify_uis(self):\n        for ui in self.uis:\n            ui.settings_changed(settings)", ""]}
{"filename": "modules/iflab/ui/dream.py", "chunked_list": ["from .pipeline import PipelineUI, catch_handler_errors\n\nclass Txt2ImgUI(PipelineUI):\n    def __init__(self, pipeline):\n        super().__init__(pipeline)\n        self.IMAGE_FOLDER = \"dream\"\n\n    def _tune_ui(self):\n        self.images_box.layout.display = \"none\"\n        self.info_button.tooltip = \"Generate images from a text prompt\"\n\n    def on_display_info(self, button):\n        pass\n        #webbrowser.open(\"https://github.com/deep-floyd/IF#i-dream\")\n\n    def get_title(self):\n        return \"Dream\"", "\n"]}
{"filename": "modules/iflab/ui/main.py", "chunked_list": ["import importlib\n\nimport ipywidgets as widgets\nfrom IPython.core.display_functions import clear_output\nfrom IPython.display import display\nfrom ipywidgets import HTML, VBox, Layout\n\nfrom ..const import VERSION\nfrom ..settings import settings\nfrom ..pipelines.inpainting import InpaintingPipeline", "from ..settings import settings\nfrom ..pipelines.inpainting import InpaintingPipeline\nfrom ..pipelines.super_resolution import SuperResolutionPipeline\nfrom ..pipelines.style_transfer import StylePipeline\nfrom ..pipelines.dream import DreamPipeline\nfrom .settings import SettingsUI\nfrom .super_resolution import SuperResolutionUI\nfrom .dream import Txt2ImgUI\nfrom .style_transfer import Img2ImgUI\nfrom .inpainting import InpaintingUI", "from .style_transfer import Img2ImgUI\nfrom .inpainting import InpaintingUI\nfrom .pnginfo import PNGInfoUI\n\n\nclass DeepFloydIFUI:\n    def __init__(self, stages=None):\n        self.stages = stages\n        self.root_box = None\n        self.title_label = None\n        self.uis = None\n        self.inpainting = None\n        self.super_resolution = None\n        self.style_transfer = None\n        self.dream = None\n        self.tabs = None\n\n        if stages:\n            self.init(stages)\n\n    def init(self, stages):\n        self.tabs = widgets.Tab()\n\n        self.dream = self.create_dream_ui(stages)\n        self.style_transfer = self.create_style_ui(stages)\n        self.super_resolution = self.create_sr_ui(stages)\n        self.inpainting = self.create_inpainting_ui(stages)\n\n        self.uis = [\n            self.dream,\n            self.style_transfer,\n            self.super_resolution,\n            self.inpainting\n        ]\n        pipeline_uis = self.uis[:]\n\n        pnginfo_ui = PNGInfoUI(self.uis, self.tabs)\n        self.uis.append(pnginfo_ui)\n\n        settings_ui = SettingsUI(self.uis)\n        self.uis.append(settings_ui)\n\n        for ui in pipeline_uis:\n            ui.save_ui_state = self.save_ui_state\n            ui.load_ui_state = self.load_ui_state\n            ui.send_to_sr = self.send_to_super_resolution\n            ui.restore_ui_state()\n\n        self.tabs.children = [ui.get() for ui in self.uis]\n\n        for i in range(len(self.tabs.children)):\n            self.tabs.set_title(i, self.uis[i].get_title())\n\n        self.title_label = widgets.Label(f\"DeepFloyd IF Lab v{VERSION}\",\n                                         layout=Layout(display=\"flex\", justify_content=\"flex-end\"))\n\n        if settings.get(\"remember_ui_state\", False):\n            self.tabs.selected_index = settings.get(\"active_tab\", 0)\n\n        self.root_box = VBox([self.title_label, self.tabs])\n\n    def create_dream_ui(self, stages):\n        dream_pipeline = DreamPipeline(stages)\n        return Txt2ImgUI(dream_pipeline)\n\n    def create_style_ui(self, stages):\n        style_pipeline = StylePipeline(stages)\n        return Img2ImgUI(style_pipeline)\n\n    def create_sr_ui(self, stages):\n        sr_pipeline = SuperResolutionPipeline(stages)\n        return SuperResolutionUI(sr_pipeline)\n\n    def create_inpainting_ui(self, stages):\n        inpainting_pipeline = InpaintingPipeline(stages)\n        return InpaintingUI(inpainting_pipeline)\n\n    def save_ui_state(self, key, state):\n        ui_state = settings.get(\"ui_state\", {})\n        ui_state[key] = state\n        settings[\"ui_state\"] = ui_state\n        settings[\"active_tab\"] = self.tabs.selected_index\n        settings.save()\n\n    def load_ui_state(self, key):\n        ui_state = settings.get(\"ui_state\", {})\n        return ui_state.get(key, None)\n\n    def send_to_super_resolution(self, image, parameters):\n        self.super_resolution.set_support_image(image, parameters)\n        self.tabs.selected_index = 2\n\n    def get(self):\n        return self.root_box\n\n    def show(self):\n        self._apply_style()\n        display(self.root_box)\n\n    @staticmethod\n    def load():\n        stages_module = importlib.import_module('.'.join(__name__.split('.')[:-2]) + \".pipelines.stages\")\n        if_stages = stages_module.DeepFloydIFStages()\n        if_stages.load()\n\n        clear_output()\n\n        ui = DeepFloydIFUI()\n        ui.init(if_stages)\n        return ui\n\n    def _apply_style(self):\n        display(\n            HTML(\n                \"\"\"\n                    <style>\n                    .lm-TabBar-tab {\n                        flex: 0 1 var(--jp-widgets-horizontal-tab-width);\n                        min-width: 35px;\n                        min-height: calc(var(--jp-widgets-horizontal-tab-height) + var(--jp-border-width));\n                        line-height: var(--jp-widgets-horizontal-tab-height);\n                        margin-left: calc(-1 * var(--jp-border-width));\n                        padding: 0px 10px;\n                        background: var(--jp-layout-color2);\n                        color: var(--jp-ui-font-color2);\n                        border: var(--jp-border-width) solid var(--jp-border-color1);\n                        border-bottom: none;\n                        position: relative;\n                    }\n                    \n                    .lm-TabBar-tab.p-mod-current {\n                        color: var(--jp-ui-font-color0);\n                        /* We want the background to match the tab content background */\n                        background: var(--jp-layout-color1);\n                        min-height: calc(var(--jp-widgets-horizontal-tab-height) + 2 * var(--jp-border-width));\n                        transform: translateY(var(--jp-border-width));\n                        overflow: visible;\n                    }\n                    \n                    .lm-TabBar-tab.p-mod-current:before {\n                        position: absolute;\n                        top: calc(-1 * var(--jp-border-width));\n                        left: calc(-1 * var(--jp-border-width));\n                        content: '';\n                        height: var(--jp-widgets-horizontal-tab-top-border);\n                        width: calc(100% + 2 * var(--jp-border-width));\n                        background: var(--jp-brand-color1);\n                    }\n                    \n                    .lm-TabBar-tab:first-child {\n                        margin-left: 0;\n                    }\n                    \n                    .lm-TabBar-tab:hover:not(.p-mod-current) {\n                        background: var(--jp-layout-color1);\n                        color: var(--jp-ui-font-color1);\n                    }\n                    \n                    .lm-TabBar-tabIcon,\n                    .lm-TabBar-tabLabel,\n                    .lm-TabBar-tabCloseIcon {\n                        line-height: var(--jp-widgets-horizontal-tab-height);\n                    }\n                    \n                    .iflab-title-label {\n                        width: 99%;\n                        background-color: var(--jp-layout-color2);\n                        margin-top: 10px;\n                    }\n                    .iflab-upscale-separator {\n                        border: none;\n                        border-top: 1px solid var(--jp-layout-color2);\n                    }\n                    </style>\n                \"\"\"\n            ))", ""]}
{"filename": "modules/iflab/ui/pipeline.py", "chunked_list": ["import ast\nimport os\nimport random\nimport re\nimport json\nimport threading\nimport traceback\nfrom dataclasses import dataclass\nfrom datetime import datetime\nfrom functools import wraps", "from datetime import datetime\nfrom functools import wraps\nfrom abc import ABC, abstractmethod\n\nfrom threading import Thread\nfrom io import BytesIO\nfrom pathlib import Path\n\nimport ipywidgets as widgets\nfrom IPython.core.display import Javascript", "import ipywidgets as widgets\nfrom IPython.core.display import Javascript\nfrom IPython.core.display_functions import display\n\nfrom ipywidgets import HBox, VBox, Layout\nfrom PIL.PngImagePlugin import PngInfo\nfrom PIL import Image, ImageGrab\n\nfrom ..const import DEBUG, RESPACING_MODES, UI_THREADS, DEBUG_PROMPT\nfrom ..pipelines.stages import ModelError", "from ..const import DEBUG, RESPACING_MODES, UI_THREADS, DEBUG_PROMPT\nfrom ..pipelines.stages import ModelError\nfrom .. import SEQ_LOAD_SEPARATE\n\n\nLOADING_CHECKPOINTS = \"Loading checkpoints...\"\nDOWNLOADING_CHECKPOINTS = \"Downloading checkpoints, please wait...\"\n\ndef catch_handler_errors(method):\n    @wraps(method)\n    def wrapped(*args, **kwargs):\n        result = None\n\n        try:\n            result = method(*args, **kwargs)\n        except Exception as e:\n            with args[0].output:\n                traceback.print_exc()\n\n        return result\n    return wrapped", "def catch_handler_errors(method):\n    @wraps(method)\n    def wrapped(*args, **kwargs):\n        result = None\n\n        try:\n            result = method(*args, **kwargs)\n        except Exception as e:\n            with args[0].output:\n                traceback.print_exc()\n\n        return result\n    return wrapped", "\n\nclass PipelineUI(ABC):\n    def __init__(self, pipeline):\n        self.DEFAULT_PROMPT = DEBUG_PROMPT if DEBUG else \"\"\n        self.STAGE_I_SCALE = 2.5\n        self.STOP_BUTTON_LABEL = \"Stop\"\n        self.WAIT_BUTTON_LABEL = \"\u23f3Waiting...\"\n        self.SERIES_BUTTON_LABEL = \"Batch Stage I\"\n        self.UPSCALE_BUTTON_LABEL = \"\ud83d\udd2cUpscale\"\n\n        self.settings = {}\n        self.pipeline = pipeline\n\n        if self.pipeline:\n            self.pipeline.on_before_embeddings = self.on_before_embeddings\n            self.pipeline.on_before_generation = self.on_before_generation\n            self.pipeline.on_before_upscale = self.on_before_upscale\n            self.pipeline.on_before_checkpoints_loaded = self.on_before_checkpoints_loaded\n            self.pipeline.on_checkpoints_loaded = self.on_checkpoints_loaded\n\n        self.generation_thread = None\n        self.generation_finished_event = None\n        self.stop_generation = False\n        self.resultsI = {}\n\n        self.upscaleII = []\n        self.upscaleIII = []\n        self.upscale_resultsII = {}\n        self.upscale_result_boxes = {}\n        self.upscaling = False\n        self.upscaling_stage = None\n        self.upscaling_stage_max = None\n        self.upscaling_progress_thread = None\n        self.upscaling_progress_event = None\n        self.stop_upscale = False\n\n        self.stageI_time = 0\n        self.stageII_time = 0\n        self.stageIII_time = 0\n        self.stageIII_iter_time = 0\n\n        self.save_ui_state = lambda k, s: None\n        self.load_ui_state = lambda k: None\n        self.send_to_sr = lambda i, p: None\n\n        self.output = widgets.Output()\n        self.prompt_label = widgets.Label(\"Prompt\")\n        self.prompt_text = widgets.Textarea(value=self.DEFAULT_PROMPT, layout=Layout(width=\"99%\", height=\"6em\"))\n        self.negative_prompt_label = widgets.Label(\"Negative prompt\")\n        self.negative_prompt_text = widgets.Textarea(value=\"\", layout=Layout(width=\"99%\", height=\"6em\"))\n        self.style_prompt_label = widgets.Label(\"Style prompt\")\n        self.style_prompt_text = widgets.Textarea(value=\"\", layout=Layout(width=\"99%\", height=\"6em\"))\n\n        self.stageI_custom_params_text = widgets.Text(\n            description='if_I_kwargs:',\n            value=self.format_custom_parameters(pipeline.custom_paramsI if pipeline else \"\"),\n            layout=Layout(width=\"99%\")\n        )\n        self.stageII_custom_params_text = widgets.Text(\n            description='if_II_kwargs:',\n            value=self.format_custom_parameters(pipeline.custom_paramsII if pipeline else \"\"),\n            layout=Layout(width=\"99%\")\n        )\n        self.stageIII_custom_params_text = widgets.Text(\n            description='if_III_kwargs:',\n            value=self.format_custom_parameters(pipeline.custom_paramsIII if pipeline else \"\"),\n            layout=Layout(width=\"99%\")\n        )\n        self.aspect_ratio_text = widgets.Text(\n            value='1:1',\n            description='Aspect Ratio'\n        )\n        self.sIII_pass_prompt_check = widgets.Checkbox(\n            description=\"Pass prompt to the stage III\"\n        )\n        self.sIII_pass_prompt_check.value = True\n        self.custom_parameter_box = VBox([\n            widgets.Label(\"Advanced options\"),\n            self.stageI_custom_params_text,\n            self.stageII_custom_params_text,\n            self.stageIII_custom_params_text,\n            self.aspect_ratio_text,\n            self.sIII_pass_prompt_check\n        ], layout=Layout(display=\"none\"))\n\n        self.prompt_box = VBox([self.prompt_label, self.prompt_text,\n                                self.negative_prompt_label, self.negative_prompt_text,\n                                self.style_prompt_label, self.style_prompt_text,\n                                self.custom_parameter_box],\n                               layout=Layout(flex=\"1 0 auto\"))\n\n        self.params_label = widgets.Label(\" \")\n        self.batch_images_slider = widgets.IntSlider(\n            value=2 if DEBUG else 100,\n            min=1,\n            max=250,\n            step=1,\n            description='Batch Images',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.respacingI_slider = widgets.SelectionSlider(\n            options=RESPACING_MODES,\n            value='smart27' if DEBUG else 'smart100',\n            description='Respacing I',\n            orientation='horizontal',\n            readout=True\n        )\n        self.guidanceI_slider = widgets.IntSlider(\n            value=7,\n            min=1,\n            max=20,\n            step=1,\n            description='Guidance I',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.respacingII_slider = widgets.SelectionSlider(\n            options=RESPACING_MODES,\n            value='smart50',\n            description='Respacing II',\n            orientation='horizontal',\n            readout=True\n        )\n        self.guidanceII_slider = widgets.IntSlider(\n            value=4,\n            min=1,\n            max=20,\n            step=1,\n            description='Guidance II',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.respacingIII_slider = widgets.IntSlider(\n            value=75,\n            min=0,\n            max=200,\n            step=5,\n            description='Respacing III',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.guidanceIII_slider = widgets.IntSlider(\n            value=4,\n            min=1,\n            max=20,\n            step=1,\n            description='Guidance III',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.noiseIII_slider = widgets.IntSlider(\n            value=20,\n            min=1,\n            max=100,\n            step=1,\n            description='Noise III',\n            orientation='horizontal',\n            readout=True,\n            readout_format='d'\n        )\n        self.seed_number = widgets.IntText(\n            value=-1,\n            description='Seed',\n            disabled=False\n        )\n\n        self.fast_presets = widgets.Button(\n            description='Fast',\n            tooltip='Fast generation (prompt tuning)',\n            layout=Layout(width=\"33.3%\")\n        )\n        self.fast_presets.on_click(self.on_set_fast_presets)\n        self.default_presets = widgets.Button(\n            description='Default',\n            tooltip='Default settings',\n            layout=Layout(width=\"33.3%\")\n        )\n        self.default_presets.on_click(self.on_set_default_presets)\n        self.hq_presets = widgets.Button(\n            description='Elaborate',\n            tooltip='Slow generation (more details)',\n            layout=Layout(width=\"33.3%\")\n        )\n        self.hq_presets.on_click(self.on_set_hq_presets)\n        self.preset_box = HBox([self.fast_presets, self.default_presets, self.hq_presets])\n\n        self.params_box = VBox([self.params_label, self.batch_images_slider, self.respacingI_slider, self.guidanceI_slider,\n                                self.respacingII_slider, self.guidanceII_slider,\n                                self.respacingIII_slider, self.guidanceIII_slider, self.noiseIII_slider,\n                                self.seed_number, self.preset_box])\n\n        self.input_box = HBox([self.prompt_box, self.params_box], layout=Layout(width=\"100%\"))\n\n        self.info_button = widgets.Button(description='\u2139\ufe0f', tooltip='', layout=Layout(width='40px'),\n                                          style={\"button_color\": \"#212121\"})\n        self.info_button.on_click(self.on_display_info)\n\n        self.generate_button = widgets.Button(\n            description='Stage I',\n            tooltip='Generate stage I image'\n        )\n        self.generate_button.on_click(self.on_generate_click)\n\n        self.generate_series_button = widgets.Button(\n            description=self.SERIES_BUTTON_LABEL,\n            tooltip='Generate a series of stage I images'\n        )\n        self.generate_series_button.on_click(self.on_generate_series_click)\n        self.clear_results_button = widgets.Button(\n            description='\ud83d\uddd1\ufe0f',\n            tooltip='Clear stage I results',\n            layout=Layout(width=\"40px\")\n        )\n        self.clear_results_button.on_click(self.clear_results)\n        self.clear_results_button2 = widgets.Button(\n            description='\ud83d\uddd1\ufe0f',\n            tooltip='Clear stage I results',\n            layout=Layout(width=\"40px\")\n        )\n        self.clear_results_button2.on_click(self.clear_results)\n        self.upscale_button = widgets.Button(\n            description=self.UPSCALE_BUTTON_LABEL,\n            tooltip='Upscale the selected stage I images'\n        )\n        self.upscale_button.on_click(self.on_upscale_click)\n        self.upscale_button2 = widgets.Button(\n            description=self.UPSCALE_BUTTON_LABEL,\n            tooltip='Upscale the selected stage I images'\n        )\n        self.upscale_button2.on_click(self.on_upscale_click)\n        self.embeddings_button = widgets.Button(\n            description='T5',\n            tooltip='Only generate T5 embeddings',\n            layout=Layout(width=\"40px\", display=\"block\")\n        )\n        self.embeddings_button.on_click(lambda b: self.compute_embeddings())\n        self.pnginfo_button = widgets.FileUpload(\n            description='PNG Info',\n            accept='.png',\n            multiple=False,\n            tooltip='Load PNG Info from image'\n        )\n        self.pnginfo_button.observe(self.load_pnginfo, 'value', type='change')\n        self.clear_upscales_button = widgets.Button(\n            description='\ud83d\uddd1\ufe0f',\n            tooltip='Clear upscales',\n            layout=Layout(width=\"40px\")\n        )\n        self.clear_upscales_button.on_click(self.clear_upscales)\n        self.clear_upscales_button2 = widgets.Button(\n            description='\ud83d\uddd1\ufe0f',\n            tooltip='Clear upscales',\n            layout=Layout(width=\"40px\")\n        )\n        self.clear_upscales_button2.on_click(self.clear_upscales)\n        self.custom_parameters_button = widgets.Button(\n            description='\ud83c\udfb0',\n            tooltip='Advanced options',\n            layout=Layout(width=\"40px\")\n        )\n        self.custom_parameters_button.on_click(self.toggle_custom_parameters)\n        self.random_seed_button = widgets.Button(\n            description='\ud83c\udfb2',\n            tooltip='Use random seed',\n            layout=Layout(width=\"40px\")\n        )\n        self.random_seed_button.on_click(lambda b: setattr(self.seed_number, \"value\", -1))\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        padder = HBox([], layout=Layout(flex=\"0 1 10px\"))\n\n        self.button_box = HBox([self.info_button, self.generate_button, self.generate_series_button,\n                                self.clear_results_button, self.upscale_button, self.clear_upscales_button,\n                                self.custom_parameters_button, self.random_seed_button, spacer,\n                                self.pnginfo_button, padder],\n                               layout=Layout(flex=\"1 0 auto\"))\n\n        self.progress_bar = widgets.IntProgress(\n            value=0,\n            min=0,\n            max=0,\n            bar_style='',\n            orientation='horizontal',\n            layout=Layout(width=\"100%\")\n        )\n\n        self.stageI_results_label = widgets.Label(\"\u00a0Stage I Results\", layout=Layout(display=\"none\"),\n                                                  style={\"font_weight\": \"bold\"})\n        self.stageI_results_label.add_class(\"iflab-title-label\")\n        self.upscale_results_label = widgets.Label(\"\u00a0Upscale Results\", layout=Layout(display=\"none\"),\n                                                   style={\"font_weight\": \"bold\"})\n        self.upscale_results_label.add_class(\"iflab-title-label\")\n\n        self.status_box = HBox([], layout=Layout(width=\"272px\", flex=\"0 0 auto\"))\n        self.status_icon = widgets.Label(value=\"\u00a0\u00a0\", layout=Layout(width=\"2em\"))\n        self.status_container = HBox([self.status_icon, self.status_box])\n\n        self.control_box = HBox([self.button_box, self.status_container],\n                                layout=Layout(width=\"100%\", margin=\"20px 0\"))\n\n        self.upload_support_img_button = widgets.FileUpload(\n            description='Source Image',\n            multiple=False,\n            tooltip='Load source image'\n        )\n        self.upload_support_img_button.observe(self.load_support_image, 'value', type='change')\n        self.paste_support_img_button = widgets.Button(\n            description='Paste',\n            tooltip='Paste support image from clipboard'\n        )\n        self.paste_support_img_button.on_click(self.paste_support_image)\n\n        self.upload_mask_img_button = widgets.FileUpload(\n            description='Mask Image',\n            multiple=False,\n            tooltip='Load mask image',\n            layout=Layout(display=\"none\")\n        )\n        self.upload_mask_img_button.observe(self.load_mask_image, 'value', type='change')\n        self.paste_mask_img_button = widgets.Button(\n            description='Paste',\n            tooltip='Paste mask image from clipboard',\n            layout=Layout(display=\"none\")\n        )\n        self.paste_mask_img_button.on_click(self.paste_mask_image)\n\n        self.support_img_view = widgets.Image(layout=Layout(width=\"max-content\", height=\"max-content\", max_width=\"95%\", display=\"none\"))\n        self.mask_img_view = widgets.Image(layout=Layout(width=\"max-content\", height=\"max-content\", max_width=\"95%\", display=\"none\"))\n\n        self.support_image_box = HBox([self.support_img_view], layout=Layout(width=\"50%\"))\n        self.mask_image_box = HBox([self.mask_img_view], layout=Layout(width=\"50%\"))\n\n        self.images_box = VBox([\n            HBox([\n                HBox([self.upload_support_img_button,\n                      self.paste_support_img_button],\n                     layout=Layout(width=\"50%\")),\n                HBox([self.upload_mask_img_button,\n                      self.paste_mask_img_button],\n                     layout=Layout(width=\"50%\"))\n            ]),\n            HBox([self.support_image_box,\n                  self.mask_image_box])\n        ], layout=Layout(width=\"100%\"))\n\n        self.result_box = HBox([], layout=Layout(width=\"100%\", margin=\"20px 0\", flex_flow=\"row wrap\", display=\"none\"))\n        self.result_button_box = VBox([\n            widgets.HTML(\"<hr class='iflab-upscale-separator'>\"),\n            HBox([self.upscale_button2, self.clear_results_button2])\n        ], layout=Layout(width=\"100%\", margin=\"5px 0\", display=\"none\"))\n        self.upscale_box = VBox([], layout=Layout(width=\"100%\", margin=\"20px 0\", display=\"none\"))\n        self.upscale_button_box = VBox([\n            widgets.HTML(\"<hr class='iflab-upscale-separator'>\"),\n            HBox([self.clear_upscales_button2])\n        ], layout=Layout(width=\"100%\", margin=\"5px 0\", display=\"none\"))\n\n        self.root_box = VBox([self.input_box, self.control_box, self.images_box,\n                              self.stageI_results_label, self.result_box,self.result_button_box,\n                              self.upscale_results_label, self.upscale_box, self.upscale_button_box,\n                              self.output],\n                             layout=Layout(width=\"100%\"))\n\n        self._tune_ui()\n\n    def _get_nsfw_status(self, result, stage):\n        nsfw = result.tensors is not None and result.tensors[stage] is not None \\\n               and hasattr(result.tensors[stage], \"hentai\")\n        return \"*\" if nsfw else \"\"\n\n    def _image_to_bytes(self, image):\n        b = BytesIO()\n        image.save(b, format='png')\n        b.seek(0)\n        return b.read()\n\n    def _get_file_name(self, time, seed, stage):\n        time_label = self._get_time_label(time)\n        output_dir = os.getenv(\"IFLAB_OUTPUT_DIR\", \"outputs\")\n\n        return f\"{output_dir}/{self.IMAGE_FOLDER}/{time_label}-{seed}-stage-{stage}.png\"\n\n    def _get_time_label(self, t):\n        d = datetime.fromtimestamp(t)\n        return d.strftime(\"%Y%m%d_%H%M%S\")\n\n    def status_message(self, text):\n        self.status_box.children = [widgets.Label(text)]\n\n    def set_status_idle(self):\n        self.status_icon.value = \"\u00a0\u00a0\"\n\n    def set_status_computing(self):\n        self.status_icon.value = \"\ud83d\udcbb\"\n\n    def set_status_waiting(self):\n        self.status_icon.value = \"\u23f3\"\n\n    def set_status_result(self):\n        self.status_icon.value = \"\ud83d\udcf6\"\n\n    def set_status_error(self):\n        self.status_icon.value = \"\u26a0\ufe0f\"\n\n    def show_progress_bar(self):\n        self.progress_bar.value = 0\n        self.status_box.children = [self.progress_bar]\n\n    def is_prompt_valid(self):\n        return self.prompt_text.value or self.negative_prompt_text.value or self.style_prompt_text.value\n\n    def set_ui_parameters(self, parameters, is_pnginfo=False):\n        self.prompt_text.value = parameters.get(\"prompt\", \"\")\n        self.negative_prompt_text.value = parameters.get(\"negative_prompt\", \"\")\n        self.style_prompt_text.value = parameters.get(\"style_prompt\", \"\")\n        self.seed_number.value = parameters.get(\"seed\", -1)\n        self.aspect_ratio_text.value = parameters.get(\"aspect_ratio\", \"\")\n        self.guidanceI_slider.value = parameters.get(\"guidanceI\", 1)\n        self.respacingI_slider.value = parameters.get(\"respacingI\", \"\")\n        self.guidanceII_slider.value = parameters.get(\"guidanceII\", 1)\n        self.respacingII_slider.value = parameters.get(\"respacingII\", \"\")\n        self.guidanceIII_slider.value = parameters.get(\"guidanceIII\", 1)\n        self.respacingIII_slider.value = int(parameters.get(\"respacingIII\", 1))\n        self.noiseIII_slider.value = parameters.get(\"noiseIII\", 1)\n        self.stageI_custom_params_text.value = parameters.get(\"if_I_kwargs\", \"\") or \"\"\n        self.stageII_custom_params_text.value = parameters.get(\"if_II_kwargs\", \"\") or \"\"\n        self.stageIII_custom_params_text.value = parameters.get(\"if_III_kwargs\", \"\") or \"\"\n        self.sIII_pass_prompt_check.value = parameters.get(\"pass_prompt_to_stage_III\", True)\n\n        if is_pnginfo:\n            self.mask_image_box.children = [widgets.HTML(f\"\"\"\n                Stage: {parameters.get(\"stage\", \"\")}<br>\n                Stage I model: {parameters.get(\"stageI_model\", \"\")}<br>\n                Stage II model: {parameters.get(\"stageII_model\", \"\")}<br>\n                Stage III model: {parameters.get(\"stageIII_model\", \"\")}<br>\n                T5 precision: {parameters.get(\"t5_precision\", \"\")}<br>\n            \"\"\")]\n\n    def set_seed_value(self, seed):\n        self.seed_number.value = seed\n\n    def on_set_fast_presets(self, button):\n        self.respacingI_slider.value = \"smart27\"\n        self.respacingII_slider.value = \"smart27\"\n        self.respacingIII_slider.value = 20\n        self.guidanceIII_slider.value = 4\n\n    def on_set_default_presets(self, button):\n        self.aspect_ratio_text.value = \"1:1\"\n        self.guidanceI_slider.value = 7.0\n        self.respacingI_slider.value = \"smart100\"\n        self.guidanceII_slider.value = 4.0\n        self.respacingII_slider.value = \"smart50\"\n        self.guidanceIII_slider.value = 9.0\n        self.respacingIII_slider.value = 75\n        self.noiseIII_slider.value = 20\n\n    def on_set_hq_presets(self, button):\n        self.respacingI_slider.value = \"smart185\"\n        self.respacingII_slider.value = \"smart185\"\n        self.respacingIII_slider.value = 180\n        self.guidanceIII_slider.value = 4\n\n    def get_ui_parameters(self):\n        parameters = {\n            \"prompt\": self.prompt_text.value,\n            \"negative_prompt\": self.negative_prompt_text.value,\n            \"style_prompt\": self.style_prompt_text.value,\n            \"seed\": self.seed_number.value,\n            \"aspect_ratio\": self.aspect_ratio_text.value,\n            \"guidanceI\": self.guidanceI_slider.value,\n            \"respacingI\": self.respacingI_slider.value,\n            \"guidanceII\": self.guidanceII_slider.value,\n            \"respacingII\": self.respacingII_slider.value,\n            \"guidanceIII\": self.guidanceIII_slider.value,\n            \"respacingIII\": self.respacingIII_slider.value,\n            \"noiseIII\": self.noiseIII_slider.value,\n            \"if_I_kwargs\": self.stageI_custom_params_text.value,\n            \"if_II_kwargs\": self.stageII_custom_params_text.value,\n            \"if_III_kwargs\": self.stageIII_custom_params_text.value,\n            \"pass_prompt_to_stage_III\": self.sIII_pass_prompt_check.value\n        }\n\n        return parameters\n\n    def persist_ui_state(self):\n        if self.settings.get(\"remember_ui_state\", False):\n            key = self.pipeline.__class__.__name__\n            parameters = self.get_ui_parameters()\n            self.save_ui_state(key, parameters)\n\n    def restore_ui_state(self):\n        if self.settings.get(\"remember_ui_state\", False):\n            parameters = self.load_ui_state(self.pipeline.__class__.__name__)\n            if parameters:\n                self.set_ui_parameters(parameters)\n\n    def get_result_pnginfo(self, seed, stage):\n        parameters = {\n            \"prompt\": self.pipeline.prompt or \"\",\n            \"negative_prompt\": self.pipeline.negative_prompt or \"\",\n            \"style_prompt\": self.pipeline.style_prompt or \"\",\n            \"seed\": seed,\n            \"stage\": stage,\n            \"batch_size\": 1,\n            \"batch_image\": 1,\n            \"t5_precision\": self.pipeline.stages.t5_dtype,\n            \"stageI_model\": self.pipeline.stages.stageI_model_name,\n            \"stageII_model\": self.pipeline.stages.stageII_model_name,\n            \"stageIII_model\": self.pipeline.stages.stageIII_model_name,\n            \"aspect_ratio\": self.pipeline.aspect_ratio,\n            \"guidanceI\": self.pipeline.guidanceI,\n            \"respacingI\": self.pipeline.stepsI,\n            \"guidanceII\": self.pipeline.guidanceII,\n            \"respacingII\": self.pipeline.stepsII,\n            \"guidanceIII\": self.pipeline.guidanceIII,\n            \"respacingIII\": str(self.pipeline.stepsIII),\n            \"noiseIII\": self.pipeline.noiseIII,\n            \"if_I_kwargs\": self.pipeline.custom_paramsI,\n            \"if_II_kwargs\": self.pipeline.custom_paramsII,\n            \"if_III_kwargs\": self.pipeline.custom_paramsIII,\n            \"pass_prompt_to_stage_III\": self.sIII_pass_prompt_check.value\n        }\n\n        parameters_sd = (self.pipeline.prompt or \"\") + \"\\nNegative prompt: \" + (self.pipeline.negative_prompt or \"\")\n\n        pnginfo = PngInfo()\n        pnginfo.add_text(\"deepfloyd_if\", json.dumps(parameters))\n        pnginfo.add_text(\"parameters\", parameters_sd)\n        return pnginfo\n\n    @catch_handler_errors\n    def load_pnginfo(self, e):\n        if e[\"name\"] == \"value\":\n            file = e[\"new\"][0]\n            image = Image.open(BytesIO(file[\"content\"].tobytes()))\n            parameters_json = image.text.get(\"deepfloyd_if\", None)\n\n            if parameters_json:\n                parameters = json.loads(parameters_json)\n\n                parameters_modelI = parameters.get(\"stageI_model\", None)\n                current_modelI = self.settings.get(\"stageI_model\", None)\n\n                if parameters_modelI and current_modelI and parameters_modelI != current_modelI:\n                    with self.output:\n                        display(Javascript(f\"alert('Warning: the current stage I model {current_modelI} \"\n                                            + f\"differs from the stored {parameters_modelI}.')\"))\n\n                self.set_ui_parameters(parameters, self.__class__.__name__ == \"PNGInfoUI\")\n\n    @catch_handler_errors\n    def load_support_image(self, e):\n        if e[\"name\"] == \"value\":\n            file = e[\"new\"][0]\n            self.support_img_view.value = file[\"content\"].tobytes()\n            self.support_img_view.layout.display = \"inline-block\"\n\n    @catch_handler_errors\n    def paste_support_image(self, button):\n        image = ImageGrab.grabclipboard()\n        self.support_img_view.value = self._image_to_bytes(image)\n        self.support_img_view.layout.display = \"inline-block\"\n\n    @catch_handler_errors\n    def paste_mask_image(self, button):\n        image = ImageGrab.grabclipboard()\n        self.mask_img_view.value = self._image_to_bytes(image)\n        self.mask_img_view.layout.display = \"inline-block\"\n\n    @catch_handler_errors\n    def load_mask_image(self, e):\n        if e[\"name\"] == \"value\":\n            file = e[\"new\"][0]\n            self.mask_img_view.value = file[\"content\"].tobytes()\n            self.mask_img_view.layout.display = \"inline-block\"\n\n    def toggle_custom_parameters(self, button):\n        if self.custom_parameter_box.layout.display == \"none\":\n            self.custom_parameter_box.layout.display = \"block\"\n        else:\n            self.custom_parameter_box.layout.display = \"none\"\n\n    def format_custom_parameters(self, params):\n        result = \"\"\n\n        if params:\n            params = [k + \"=\" + (f\"'{v}'\" if isinstance(v, str) else str(v)) for k, v in params.items()]\n            result = \", \".join(params)\n\n        return result\n\n    def eval_custom_parameters(self, param_str):\n        if param_str:\n            def param_func(**kwargs):\n                return kwargs\n\n            try:\n                return eval(f\"param_func({param_str})\")\n            except Exception as e:\n                print(f\"Error evaluating custom parameters: {param_str}\")\n\n    def setup_pipeline(self, override_args={}):\n        # to save correct PNGInfo from facade-generated images\n        def ovr(key1, key2=None):\n            if key2:\n                v1 = override_args.get(key1, None)\n                if v1:\n                    return v1.get(key2, None)\n            else:\n                return override_args.get(key1, None)\n\n        self.pipeline.override_args = override_args\n        self.pipeline.aspect_ratio = ovr(\"aspect_ratio\") or self.aspect_ratio_text.value\n        self.pipeline.guidanceI = ovr(\"if_I_kwargs\", \"guidance_scale\") or float(self.guidanceI_slider.value)\n        self.pipeline.stepsI = ovr(\"if_I_kwargs\", \"sample_timestep_respacing\") or self.respacingI_slider.value\n        self.pipeline.guidanceII = ovr(\"if_II_kwargs\", \"guidance_scale\") or float(self.guidanceII_slider.value)\n        self.pipeline.stepsII = ovr(\"if_II_kwargs\", \"sample_timestep_respacing\") or self.respacingII_slider.value\n        self.pipeline.guidanceIII = ovr(\"if_III_kwargs\", \"guidance_scale\") or float(self.guidanceIII_slider.value)\n        self.pipeline.stepsIII = ovr(\"if_III_kwargs\", \"sample_timestep_respacing\") or self.respacingIII_slider.value\n        if isinstance(self.pipeline.stepsIII, str):\n            self.pipeline.stepsIII = int(self.pipeline.stepsIII)\n        self.pipeline.noiseIII = ovr(\"if_III_kwargs\", \"noise_level\") or self.noiseIII_slider.value\n        self.pipeline.custom_paramsI = self.eval_custom_parameters(self.stageI_custom_params_text.value)\n        self.pipeline.custom_paramsII = self.eval_custom_parameters(self.stageII_custom_params_text.value)\n        self.pipeline.custom_paramsIII = self.eval_custom_parameters(self.stageIII_custom_params_text.value)\n\n        self.pipeline.iterationsI = int(re.findall(\"\\d+\", self.pipeline.stepsI)[0])\n        self.pipeline.iterationsII = int(re.findall(\"\\d+\", self.pipeline.stepsII)[0])\n        self.pipeline.iterationsIII = self.pipeline.stepsIII\n        self.pipeline.disable_watermark = self.settings.get(\"disable_watermark\", False)\n        self.pipeline.pass_prompt_to_stage_III = self.sIII_pass_prompt_check.value\n\n        if self.support_img_view.layout.display != \"none\":\n            image = Image.open(BytesIO(self.support_img_view.value))\n            self.pipeline.support_image = image\n\n        if self.mask_img_view.layout.display != \"none\":\n            image = Image.open(BytesIO(self.mask_img_view.value))\n            self.pipeline.mask_image = image\n\n    def compute_embeddings(self):\n        if not self.is_prompt_valid():\n            self.status_message(\"Please provide a prompt\")\n\n        prompt = self.prompt_text.value or None\n        negative_prompt = self.negative_prompt_text.value or None\n        style_prompt = self.style_prompt_text.value or None\n\n        update_prompt = prompt != self.pipeline.prompt\n        update_negative = negative_prompt != self.pipeline.negative_prompt\n        update_style = style_prompt != self.pipeline.style_prompt\n\n        if update_prompt or update_negative or update_style:\n            try:\n                self.pipeline.prompt = prompt\n                self.pipeline.negative_prompt = negative_prompt\n                self.pipeline.style_prompt = style_prompt\n                self.pipeline.compute_t5_embs(update_prompt, update_negative, update_style)\n                self.output.clear_output()\n                self.show_progress_bar()\n            except Exception as e:\n                self.status_message(str(e))\n                self.set_status_error()\n\n    @catch_handler_errors\n    def on_generate_click(self, button):\n        if self.generation_thread is None:\n            with self.output:\n                self.persist_ui_state()\n                self.reset_results()\n                self.setup_pipeline()\n                self.compute_embeddings()\n\n                seed = self.seed_number.value\n                seed = seed if seed > 0 else None\n\n                if UI_THREADS:\n                    self.generation_thread = Thread(target=lambda: self.generate_series(seed=seed, steps=1, single=True))\n                    self.generation_thread.start()\n                else:\n                    self.generate_series(seed=seed, steps=1, single=True)\n\n    @catch_handler_errors\n    def on_generate_series_click(self, button):\n        with self.output:\n            if button.description == self.STOP_BUTTON_LABEL:\n                button.description = self.SERIES_BUTTON_LABEL\n                self.stop_generation = True\n            elif self.generation_thread is None:\n                button.description = self.STOP_BUTTON_LABEL\n                self.persist_ui_state()\n                self.reset_results()\n                self.setup_pipeline()\n                self.compute_embeddings()\n\n                steps = self.batch_images_slider.value\n\n                if UI_THREADS:\n                    self.generation_thread = Thread(target=lambda: self.generate_series(button=button, steps=steps))\n                    self.generation_thread.start()\n                else:\n                    self.generate_series(button=button, steps=steps)\n\n    @catch_handler_errors\n    def on_upscale_click(self, button):\n        with self.output:\n            if button.description == self.STOP_BUTTON_LABEL:\n                self.upscale_button.description = self.UPSCALE_BUTTON_LABEL\n                self.upscale_button2.description = self.UPSCALE_BUTTON_LABEL\n                self.stop_upscale = True\n            elif self.generation_thread is None:\n                self.upscale_button.description = self.STOP_BUTTON_LABEL\n                self.upscale_button2.description = self.STOP_BUTTON_LABEL\n                self.persist_ui_state()\n                self.show_progress_bar()\n                self.reset_upscale_results()\n                self.setup_pipeline()\n                self.compute_embeddings()\n\n                if UI_THREADS:\n                    self.generation_thread = Thread(target=self.generate_upscales)\n                    self.generation_thread.start()\n                else:\n                    self.generate_upscales()\n            elif self.generation_thread is not None and button.description != self.WAIT_BUTTON_LABEL:\n                self.upscale_button.description = self.WAIT_BUTTON_LABEL\n                self.upscale_button2.description = self.WAIT_BUTTON_LABEL\n                self.stop_generation = True\n                self.generation_finished_event.wait()\n                self.on_upscale_click(button)\n\n    def on_before_embeddings(self):\n        self.set_status_computing()\n        self.status_message(\"Computing T5 Embeddings...\")\n\n    def on_before_generation(self):\n        self.set_status_computing()\n        self.show_progress_bar()\n\n    @catch_handler_errors\n    def generate_series(self, button=None, seed=None, steps=None, single=False):\n        error = False\n\n        try:\n            self.upscaling = False\n            generate_seed = seed is None\n\n            self.generation_finished_event = threading.Event()\n            self.stop_generation = False\n            for i in range(0, steps):\n                if self.stop_generation:\n                    break\n\n                if generate_seed:\n                    seed = self.pipeline.generate_seed()\n\n                result = self.pipeline.generate(seed, progress=self.update_progress)\n                self.process_stageI_result(result)\n\n            if not self.upscaling:  # Super Resolution\n                self.status_message(f\"Stage I: ~{self.stageI_time}s\")\n\n        except ModelError as e:\n            error = True\n            self.status_message(str(e))\n        except MemoryError as e:\n            error = True\n            self.status_message(\"Memory error. Please restart the kernel.\")\n        finally:\n            self.reset_progress()\n\n            if error:\n                self.set_status_error()\n            else:\n                self.set_status_result()\n            if not single:\n                button.description = self.SERIES_BUTTON_LABEL\n\n            self.generation_thread = None\n            self.generation_finished_event.set()\n\n    def update_progress(self, n, p):\n        try:\n            self.stop_stageIII_progress()\n\n            if len(self.status_box.children) and self.status_box.children[0] is not self.progress_bar:\n                self.show_progress_bar()\n\n            self.progress_bar.max = n - 1\n            self.progress_bar.value = n - 1 - p\n        except:\n            pass\n\n    def reset_progress(self):\n        self.progress_bar.value = 0\n\n    def reset_results(self):\n        random.seed(datetime.now().timestamp())\n        self.resultsI = {}\n        self.upscale_resultsII = {}\n        self.upscaleII = []\n        self.upscaleIII = []\n        self.clear_results(None)\n        self.clear_upscales(None)\n\n        self.reset_progress()\n        self.output.clear_output()\n\n    def reset_upscale_results(self):\n        self.stageII_time = 0\n        self.stageIII_time = 0\n        self.upscale_resultsII = {}\n        self.upscale_box.children = []\n        self.upscale_result_boxes = {}\n\n        self.output.clear_output()\n\n    @catch_handler_errors\n    def process_stageI_result(self, result):\n        seed = result.seed\n        image_result = result.images['I'][0]\n        size = tuple([int(x * self.STAGE_I_SCALE) for x in image_result.size])\n\n        self.resultsI[seed] = result\n        self.stageI_time = round(result.duration)\n        self.save_result(image_result, result.time, result.seed, \"I\")\n\n        if DEBUG:\n            image = image_result.resize(size, Image.Resampling.LANCZOS)\n            image_view = widgets.Image(value=self._image_to_bytes(image), format='png')\n            nsfw = self._get_nsfw_status(result, 0)\n        else:\n            file_name = self._get_file_name(result.time, seed, \"I\")\n            image_view = widgets.HTML(f\"<img src='/files/{file_name}' style='width: {size[0]}px; height: {size[1]}px'/>\",\n                                      layout=Layout(width=str(size[0]) + \"px\", height=str(size[1]) + \"px\"))\n            nsfw = \"\"\n\n        seed_text = widgets.Label(f\"Seed: {seed}{nsfw}\")\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        recycle_button = widgets.Button(\n            description=\"\u267b\ufe0f\",\n            tooltip=\"Reuse image seed\",\n            layout=Layout(width=\"30px\"),\n            style={\"button_color\": \"#212121\"}\n        )\n        recycle_button.on_click(lambda b: self.set_seed_value(seed))\n        placeholder = widgets.Label(\"\u00a0\")\n\n        top_box = widgets.HBox([seed_text, spacer, recycle_button, placeholder])\n\n        upscale_text = widgets.Label(f\"\ud83d\udd2c\", layout=Layout(width=\"20px\", flex=\"1 0 20px\"))\n        upscaleII_check = widgets.Checkbox(\n            value=False,\n            description='II',\n            indent=False,\n            layout=Layout(max_width=\"38px\")\n        )\n        upscaleII_check.observe(lambda e: self.add_upscaleII(e, seed), 'value', type='change')\n        upscaleIII_check = widgets.Checkbox(\n            value=False,\n            description='III',\n            indent=False\n        )\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        upscaleIII_check.observe(lambda e: self.add_upscaleIII(e, seed), 'value', type='change')\n        upscale_sr_button = widgets.Button(\n            description=\"SR\",\n            tooltip=\"Send to Super Resolution\",\n            style={\"button_color\": \"#212121\"}\n        )\n\n        def on_send_to_sr_click(button):\n            image_bytes = image_result\n            parameters = self.get_ui_parameters()\n            self.send_to_sr(image_bytes, parameters)\n\n        upscale_sr_button.on_click(on_send_to_sr_click)\n\n        upscale_box = HBox([upscale_text, upscaleII_check, upscaleIII_check, spacer, upscale_sr_button],\n                           layout=Layout(max_width=f\"calc({size[0]}px + 10px)\"))\n\n        result_box = VBox([top_box, image_view], layout=Layout(max_width=f\"calc({size[0]}px + 10px)\"))\n\n        if not hasattr(result, \"facade\"):\n            result_box.children += (upscale_box,)\n\n        self.result_box.layout.display = \"flex\"\n        self.result_button_box.layout.display = \"flex\"\n        self.stageI_results_label.layout.display = \"block\"\n        self.result_box.children += (result_box,)\n\n    def add_upscaleII(self, e, seed):\n        if e[\"name\"] == \"value\" and e[\"new\"]:\n            self.upscaleII.append(seed)\n        elif e[\"name\"] == \"value\" and not e[\"new\"]:\n            self.upscaleII.remove(seed)\n\n    def add_upscaleIII(self, e, seed):\n        if e[\"name\"] == \"value\" and e[\"new\"]:\n            self.upscaleIII.append(seed)\n        elif e[\"name\"] == \"value\" and not e[\"new\"]:\n            self.upscaleIII.remove(seed)\n\n    def on_before_upscale(self):\n        self.set_status_computing()\n        self.show_progress_bar()\n\n        if self.upscaling and self.upscaling_stage == \"III\":\n            self.stop_stageIII_progress()\n            self.upscaling_progress_event = threading.Event()\n            self.upscaling_progress_thread = Thread(target=self.stageIII_mock_progress)\n            self.upscaling_progress_thread.start()\n\n    def on_before_checkpoints_loaded(self, missing):\n        if missing:\n            self.status_message(DOWNLOADING_CHECKPOINTS)\n        else:\n            self.status_message(LOADING_CHECKPOINTS)\n\n        self.set_status_waiting()\n\n    def on_checkpoints_loaded(self):\n        pass\n\n    @catch_handler_errors\n    def generate_upscales(self):\n        error = False\n\n        try:\n            self.generation_finished_event = threading.Event()\n            self.upscaling = True\n            generations = {}\n            upscales = {}\n\n            for seed in self.resultsI.keys():\n                if seed in self.upscaleIII:\n                    generations[seed] = \"III\"\n                elif seed in self.upscaleII:\n                    generations[seed] = \"II\"\n                else:\n                    generations[seed] = None\n\n            for (seed, stage) in generations.items():\n                if stage:\n                    upscales[seed] = stage\n\n            total_images = len(self.upscaleIII) * 2 + len(set(self.upscaleII) - set(self.upscaleIII))\n            i = 0\n\n            self.stop_upscale = False\n            for (seed, stage) in upscales.items():\n                if self.stop_upscale:\n                    break\n\n                if self.pipeline.stages.sequential_load == SEQ_LOAD_SEPARATE:\n                    self.generate_upscale(seed, \"II\", stage, (i := i + 1), total_images)\n                else:\n                    if stage == \"II\":\n                        self.generate_upscale(seed, \"II\", stage, (i := i + 1), total_images)\n                    elif stage == \"III\":\n                        self.generate_upscale(seed, \"II\", stage, (i := i + 1), total_images)\n                        self.generate_upscale(seed, \"III\", stage, (i := i + 1), total_images)\n\n            if not self.stop_upscale and self.pipeline.stages.sequential_load == SEQ_LOAD_SEPARATE:\n                for (i, seed) in enumerate(self.upscaleIII):\n                    if self.stop_upscale:\n                        break\n                    self.generate_upscale(seed, \"III\", \"III\", (i := i + 1), total_images)\n\n            sII_time = f\"Stage II: ~{self.stageII_time}s\"\n            sIII_time = f\"Stage III: ~{self.stageIII_time}s\"\n            result_time = sII_time if self.stageIII_time == 0 else sII_time + \", \" + sIII_time\n            self.status_message(result_time)\n\n        except ModelError as e:\n            error = True\n            self.status_message(str(e))\n        except MemoryError as e:\n            error = True\n            self.status_message(\"Memory error, please restart.\")\n        finally:\n            self.reset_progress()\n\n            if error:\n                self.set_status_error()\n            else:\n                self.set_status_result()\n\n            self.generation_thread = None\n            self.generation_finished_event.set()\n            self.upscale_button.description = self.UPSCALE_BUTTON_LABEL\n            self.upscale_button2.description = self.UPSCALE_BUTTON_LABEL\n\n    def generate_upscale(self, seed, stage, stage_max, image_index=None, total_images=None):\n        self.upscaling_stage = stage\n        self.upscaling_stage_max = stage_max\n\n        if stage == \"II\":\n            self.stop_stageIII_progress()\n\n            resultI = self.resultsI[seed]\n            result = self.pipeline.upscale(resultI=resultI, progress=self.update_progress)\n\n            self.stageII_time = round(result.duration)\n            self.upscale_resultsII[seed] = result\n            self.process_upscale_result(seed, result, \"II\", stage_max, image_index, total_images)\n\n        elif stage == \"III\":\n            resultI = self.resultsI[seed]\n            resultII = self.upscale_resultsII[seed]\n            result = self.pipeline.upscale(resultI=resultI, resultII=resultII, progress=self.update_progress)\n\n            self.stageIII_time = round(result.duration)\n            self.stageIII_iter_time = result.duration / self.pipeline.iterationsIII\n            self.process_upscale_result(seed, result, \"III\", stage_max, image_index, total_images)\n\n    def process_upscale_result(self, seed, result, stage, stage_max=None, image_index=None, total_images=None):\n        image = result.images[stage][0]\n        self.save_result(image, result.time, seed, stage)\n\n        stage_index = 1 if stage == \"II\" else 2\n        nsfw = self._get_nsfw_status(result, stage_index) if DEBUG else \"\"\n        seed_text = widgets.Label(f\"Seed: {result.seed} ({stage}){nsfw}\")\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        image_index = f\"{image_index}/{total_images}\" if image_index is not None and total_images is not None else \"\"\n        image_index_label = widgets.Label(image_index)\n        image_header = HBox([seed_text, spacer, image_index_label])\n\n        if DEBUG:\n            image_view = widgets.Image(\n                value=self._image_to_bytes(image),\n                format='png',\n                layout=Layout(width=\"max-content\")\n            )\n        else:\n            file_name = self._get_file_name(result.time, seed, stage)\n            image_view = widgets.HTML(f\"<img src='/files/{file_name}' style='width: max-content'/>\")\n\n        spacer = HBox([], layout=Layout(flex=\"1 0 auto\"))\n        generateIII_button = widgets.Button(\n            description=\"III\",\n            tooltip=\"Generate stage III\",\n            layout=Layout(width=\"30px\"),\n            style={\"button_color\": \"#212121\"}\n        )\n\n        def generate_stageIII(button):\n            if self.generation_thread is None:\n                try:\n                    generateIII_button.description = \"\u23f3\"\n                    self.generation_thread = True\n                    self.generate_upscale(seed, \"III\", \"III\")\n                    generateIII_button.layout.display = \"none\"\n                    self.status_message(f\"Stage III: ~{self.stageIII_time}s\")\n                finally:\n                    self.generation_thread = None\n\n        generateIII_button.on_click(generate_stageIII)\n        result_footer = HBox([spacer, generateIII_button])\n\n        result_box = VBox([image_header, image_view], layout=Layout(max_width=\"max-content\"))\n        if stage_max == \"II\" and not hasattr(result, \"facade\"):\n            result_box.children += (result_footer,)\n        hr = widgets.HTML(\"<hr class='iflab-upscale-separator'>\")\n\n        upscale_result_box = self.upscale_result_boxes.get(seed, None)\n\n        if upscale_result_box:\n            upscale_result_box.children += (result_box,)\n        else:\n            upscale_result_box = VBox([])\n            upscale_result_box.children += (result_box,) if image_index == 1 else (hr, result_box,)\n            self.upscale_result_boxes[seed] = upscale_result_box\n            self.upscale_box.children += (upscale_result_box,)\n\n        self.upscale_box.layout.display = \"flex\"\n        self.upscale_button_box.layout.display = \"flex\"\n        self.upscale_results_label.layout.display = \"block\"\n\n    # deeper patching is required to hook into the stage III progress, so here is a mock now\n    def stageIII_mock_progress(self):\n        self.progress_bar.max = self.pipeline.iterationsIII - 1\n        wait_time = 1 if self.stageIII_iter_time == 0 else self.stageIII_iter_time\n\n        for i in range(0, self.pipeline.iterationsIII):\n            self.progress_bar.value = i\n            if self.upscaling_progress_event and self.upscaling_progress_event.wait(wait_time):\n                self.upscaling_progress_event = None\n                break\n\n    def stop_stageIII_progress(self):\n        if self.upscaling_progress_event:\n            try:\n                self.upscaling_progress_event.set()\n            except:\n                traceback.print_exc()\n\n    def clear_results(self, button):\n        self.resultsI = {}\n        self.result_box.children = []\n        self.result_box.layout.display = \"none\"\n        self.result_button_box.layout.display = \"none\"\n        self.stageI_results_label.layout.display = \"none\"\n\n    def clear_upscales(self, button):\n        self.upscale_box.children = []\n        self.upscale_box.layout.display = \"none\"\n        self.upscale_button_box.layout.display = \"none\"\n        self.upscale_results_label.layout.display = \"none\"\n\n    def save_result(self, image, time, seed, stage):\n        file_name = self._get_file_name(time, seed, stage)\n        file_dir = os.path.dirname(file_name)\n\n        p = Path(file_dir)\n        p.mkdir(parents=True, exist_ok=True)\n\n        with open(file_name, \"wb\") as f:\n            image.save(f, format='png', pnginfo=self.get_result_pnginfo(seed, stage))\n\n    def get(self):\n        return self.root_box\n\n    def settings_changed(self, new_settings):\n        self.settings = new_settings\n\n    class GeneratorFacade:\n        def __init__(self, ui, options):\n            self.ui = ui\n            self.options = options\n\n        def __call__(self, *args, **kwargs):\n            return self.ui.invoke_pipeline(kwargs, self.options)\n\n    def get_pipeline(self, **kwargs):\n        return PipelineUI.GeneratorFacade(self, kwargs)\n\n    def invoke_pipeline(self, kwargs, options):\n        update_ui = options.get(\"update_ui\", False)\n        reference_pipeline = options.get(\"reference\", False)\n        return_tensors = kwargs.get(\"return_tensors\", False)\n\n        seed = self.seed_number.value\n        seed = seed if seed > 0 else None\n\n        self.setup_pipeline(override_args=kwargs)\n        self.compute_embeddings()\n        result = self.pipeline.generate(seed=seed, progress=True, is_reference=reference_pipeline)\n        self.resultsI[seed] = result\n\n        if update_ui:\n            setattr(result, \"facade\", True)\n            self.process_stageI_result(result)\n\n        upscale = \"if_II_kwargs\" in kwargs or \"if_III_kwargs\" in kwargs\n        stage = \"III\" if \"if_III_kwargs\" in kwargs else \"II\"\n\n        if upscale:\n            if stage == \"II\":\n                result = self.pipeline.upscale(resultI=result, progress=True, is_reference=reference_pipeline)\n                setattr(result, \"facade\", True)\n                self.upscale_resultsII[seed] = result\n                if update_ui:\n                    self.process_upscale_result(seed, result, \"II\", \"II\")\n            elif stage == \"III\":\n                resultII = self.pipeline.upscale(resultI=result, progress=True, is_reference=reference_pipeline)\n                self.upscale_resultsII[seed] = result\n                if update_ui:\n                    setattr(resultII, \"facade\", True)\n                    self.process_upscale_result(seed, resultII, \"II\", \"III\")\n                result = self.pipeline.upscale(resultI=result, resultII=resultII, progress=True,\n                                               is_reference=reference_pipeline)\n                setattr(result, \"facade\", True)\n                if update_ui:\n                    self.process_upscale_result(seed, result, \"III\", \"III\")\n\n        if \"output\" in result.images:\n            del result.images[\"output\"]\n\n        return (result.images, result.tensors) if return_tensors else result.images\n\n    @abstractmethod\n    def _tune_ui(self):\n        pass\n\n    @abstractmethod\n    def get_title(self):\n        pass", ""]}
{"filename": "modules/iflab/ui/__init__.py", "chunked_list": [""]}
{"filename": "modules/iflab/ui/open.py", "chunked_list": ["import socket\nimport subprocess\nimport time\nimport os\nimport sys\nimport traceback\nfrom contextlib import closing\nfrom threading import Thread\n\n\ndef port_online(port):\n    with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as sock:\n        sock.settimeout(0.1)\n        result = sock.connect_ex((\"127.0.0.1\", int(port)))\n        if result == 0:\n            return True\n        else:\n            return False", "\n\ndef port_online(port):\n    with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as sock:\n        sock.settimeout(0.1)\n        result = sock.connect_ex((\"127.0.0.1\", int(port)))\n        if result == 0:\n            return True\n        else:\n            return False", "\n\ndef wait_for_port(port):\n    ctr = 6000\n\n    while ctr > 0:\n        if port_online(port):\n            return True\n        ctr -= 1\n        time.sleep(1)\n\n    return False", "\n\ndef open_ui_thread(port):\n    if wait_for_port(port):\n        time.sleep(3)\n\n        url = f\"http://localhost:{port}\"\n\n        if sys.platform == \"win32\":\n            os.startfile(url)\n        elif sys.platform == \"darwin\":\n            subprocess.Popen([\"open\", url])\n        else:\n            try:\n                env_mod = os.environ.copy()\n                ture_userprofile = os.getenv(\"IFLAB_TRUE_USERPROFILE\", None)\n                ture_home = os.getenv(\"IFLAB_TRUE_HOME\", None)\n\n                if ture_userprofile:\n                    env_mod[\"USERPROFILE\"] = ture_userprofile\n                if ture_home:\n                    env_mod[\"HOME\"] = ture_home\n\n                subprocess.Popen([\"xdg-open\", url], env=env_mod)\n\n            except OSError:\n                print(\"Please open a browser on: \" + url)", "\ndef open_ui(port):\n    Thread(target=lambda: open_ui_thread(port), daemon=True).start()\n"]}
{"filename": "modules/iflab/ui/style_transfer.py", "chunked_list": ["from .pipeline import PipelineUI\n\n\nclass Img2ImgUI(PipelineUI):\n    def __init__(self, pipeline):\n        super().__init__(pipeline)\n        self.IMAGE_FOLDER = \"style_transfer\"\n\n    def _tune_ui(self):\n        self.info_button.tooltip = \"Upload source image and provide a style prompt to produce image of a different style\"\n\n    def on_display_info(self, button):\n        pass\n\n    def get_title(self):\n        return \"Style Transfer\"\n\n    def generate_series(self, **kwargs):\n        with self.output:\n            if self.pipeline.style_prompt:\n                super().generate_series(**kwargs)\n            else:\n                print(\"Please provide a style prompt\")", "\n"]}
{"filename": "modules/iflab/ui/inpainting.py", "chunked_list": ["from .pipeline import PipelineUI\n\n\nclass InpaintingUI(PipelineUI):\n    def __init__(self, pipeline):\n        super().__init__(pipeline)\n        self.IMAGE_FOLDER = \"inpainting\"\n\n    def _tune_ui(self):\n        self.upload_mask_img_button.layout.display = \"block\"\n        self.paste_mask_img_button.layout.display = \"block\"\n        self.info_button.tooltip = (\"Inpaint on a region of the source image defined by the mask image\\n\" +\n                                    \"Source and mask images should be of the same size\")\n\n    def on_display_info(self, button):\n        pass\n\n    def get_title(self):\n        return \"Inpainting\""]}
{"filename": "modules/iflab/ui/super_resolution.py", "chunked_list": ["import ipywidgets as widgets\n\nfrom .pipeline import PipelineUI, catch_handler_errors\n\n\nclass SuperResolutionUI(PipelineUI):\n    def __init__(self, pipeline):\n        super().__init__(pipeline)\n        self.IMAGE_FOLDER = \"super_resolution\"\n\n    def _tune_ui(self):\n        self.SERIES_BUTTON_LABEL = \"Batch Stage III\"\n        self.result_box.layout.display = \"none\"\n        self.upscale_button.layout.display = \"none\"\n        self.clear_results_button.layout.display = \"none\"\n        self.generate_button.description = \"Stage III\"\n        self.generate_series_button.description = self.SERIES_BUTTON_LABEL\n        self.info_button.tooltip = \"Upload source image and provide a prompt to generate an upscaled version\"\n\n    def on_display_info(self, button):\n        pass\n\n    def get_title(self):\n        return \"Super Resolution\"\n\n    def on_before_generation(self):\n        self.upscaling = True\n        self.upscaling_stage = \"III\"\n        super().on_before_generation()\n\n    def process_stageI_result(self, result):\n        if self.upscaling_progress_event:\n            self.upscaling_progress_event.set()\n\n        self.process_upscale_result(result.seed, result, \"III\")\n\n        duration = round(result.duration)\n        self.status_message(f\"Stages II-III: {duration}s\")\n\n    def set_support_image(self, image, parameters):\n        self.support_img_view.value = self._image_to_bytes(image)\n        self.support_img_view.layout.display = \"inline-block\"\n        self.prompt_text.value = parameters.get(\"prompt\", \"\")\n        self.negative_prompt_text.value = parameters.get(\"negative_prompt\", \"\")\n        self.style_prompt_text.value = parameters.get(\"style_prompt\", \"\")", "\n"]}
