{"filename": "jest.config.ts", "chunked_list": ["import nextJest from \"next/jest\";\nimport { defaults } from \"jest-config\";\nimport * as dotenv from \"dotenv\";\n\ndotenv.config({ path: \"./.env.local\" });\n\nconst createJestConfig = nextJest({\n  // Provide the path to your Next.js app to load next.config.js and .env files in your test environment\n  dir: \"./\",\n});", "  dir: \"./\",\n});\n\n// Add any custom config to be passed to Jest\nconst customJestConfig = {\n  modulePaths: [\"<rootDir>/src/\"],\n  moduleDirectories: [\"node_modules\", \"<rootDir>/\"],\n  moduleFileExtensions: [...defaults.moduleFileExtensions, \"d.ts\"],\n  testTimeout: 15000,\n};", "  testTimeout: 15000,\n};\n\n// createJestConfig is exported this way to ensure that next/jest can load the Next.js config which is async\nmodule.exports = createJestConfig(customJestConfig);\n"]}
{"filename": "src/middleware.ts", "chunked_list": ["import { NextRequest, NextResponse } from \"next/server\";\n\nimport { upstashBanDuration } from \"./configs/upstash\";\nimport { enableServerAPI } from \"./configs/instagram\";\n\nimport { getClientIp } from \"@/lib/utils\";\nimport { isRatelimited } from \"./lib/rate-limiter\";\n\nconst isStaticPath = (path: string) => {\n  return (", "const isStaticPath = (path: string) => {\n  return (\n    path.startsWith(\"/_next\") ||\n    path.startsWith(\"/images\") ||\n    path.startsWith(\"/favicon.ico\") ||\n    path.startsWith(\"/og.png\") ||\n    path.startsWith(\"/robot.txt\") ||\n    path.startsWith(\"/site.webmanifest\")\n  );\n};", "  );\n};\n\nexport async function middleware(request: NextRequest) {\n  const requestPath = request.nextUrl.pathname;\n  const country = request.geo?.country ?? \"Country\";\n\n  if (isStaticPath(requestPath)) {\n    return NextResponse.next();\n  }\n", "  if (requestPath.startsWith(\"/api\") && enableServerAPI) {\n    const isLimited = await isRatelimited(request);\n    if (isLimited) {\n      const banDuration = Math.floor(upstashBanDuration / 60 / 60); // Ban duration in hours\n      return NextResponse.json(\n        {\n          error: `Too many requests, you have been banned for ${banDuration} hours.`,\n        },\n        { status: 429 }\n      );\n    }\n  }\n\n  const clientIp = getClientIp(request);\n  console.log(`${request.method} ${clientIp} (${country}) -> ${requestPath}`);\n}\n\n// See \"Matching Paths\" below to learn more\nexport const config = {\n  matcher: [\"/:path*\"],\n};\n"]}
{"filename": "src/components/navigation/index.ts", "chunked_list": ["export * from \"./LogoLink\";\nexport * from \"./MenuButton\";\nexport * from \"./NavLink\";\nexport * from \"./MobileMenuLink\";\nexport * from \"./ThemeButton\";\n"]}
{"filename": "src/configs/instagram.ts", "chunked_list": ["// Instagram Configurations\nexport const enableScraper = true;\nexport const enableGuestApi = true;\n// API endpoints\nexport const enableServerAPI = false;\n"]}
{"filename": "src/configs/site.ts", "chunked_list": ["import { SiteConfig } from \"@/types\";\n\nexport const siteConfig: SiteConfig = {\n  name: \"Instagram Saver\",\n  description:\n    \"Want to save your favorite Instagram posts for later? With our Instagram saver, you can download any photo or video from Instagram in seconds. Just copy the link, paste it in our app, and enjoy your saved content offline. Whether you want to repost, share, or just keep them for yourself, our Instagram saver is the best tool for you.\",\n  url: \"https://insta-video-saver.vercel.app/\",\n  ogImageUrl: \"https://insta-video-saver.vercel.app/og.png\",\n  links: {\n    twitter: \"https://twitter.com/riadazz\",", "  links: {\n    twitter: \"https://twitter.com/riadazz\",\n    github: \"https://github.com/riad-azz/instagram-video-downloader\",\n  },\n};\n"]}
{"filename": "src/configs/upstash.ts", "chunked_list": ["// Upstash configs\nexport const upstashUrl = process.env.UPSTASH_REDIS_REST_URL ?? \"\";\nexport const upstashToken = process.env.UPSTASH_REDIS_REST_TOKEN ?? \"\";\nconst isUsingUpstash = process.env.USE_UPSTASH ?? \"\";\nexport const enableUpstash = isUsingUpstash === \"true\";\n// Ratelimit configs\nexport const maxRequests = 5; // Max requests every requests window\nexport const requestsWindow = \"1 m\"; // 5 requests allowed every 1 min\n// Ban configs\nexport const upstashBanEnabled = true; // Ban user by ip in case of spam", "// Ban configs\nexport const upstashBanEnabled = true; // Ban user by ip in case of spam\nexport const upstashBanDuration = 14400; // 4 hours;\n"]}
{"filename": "src/configs/seo.ts", "chunked_list": ["import { siteConfig } from \"@/configs/site\";\nimport { Metadata } from \"next\";\n\nexport const mainMetadata: Metadata = {\n  metadataBase: new URL(\"https://insta-video-saver.vercel.app\"),\n  title: siteConfig.name,\n  description: siteConfig.description,\n  keywords: [\n    \"Instagram downloader\",\n    \"Reels downloader\",", "    \"Instagram downloader\",\n    \"Reels downloader\",\n    \"Instagram video downloader\",\n    \"Download Instagram videos\",\n    \"Save Instagram videos\",\n    \"Instagram reels downloader\",\n    \"Download Instagram reels\",\n    \"Save Instagram reels\",\n    \"Video downloader for Instagram\",\n    \"Instagram video saver\",", "    \"Video downloader for Instagram\",\n    \"Instagram video saver\",\n    \"Instagram reel saver\",\n    \"Instagram reel video downloader\",\n    \"Reels video saver\",\n    \"Free Instagram saver\",\n    \"Instagram video download app\",\n    \"Free Instagram downloader\",\n  ],\n  authors: [", "  ],\n  authors: [\n    {\n      name: \"riad-azz\",\n      url: \"https://github.com/riad-azz\",\n    },\n  ],\n  creator: \"riad-azz\",\n  themeColor: [\n    { media: \"(prefers-color-scheme: light)\", color: \"white\" },", "  themeColor: [\n    { media: \"(prefers-color-scheme: light)\", color: \"white\" },\n    { media: \"(prefers-color-scheme: dark)\", color: \"#1f2937\" },\n  ],\n  openGraph: {\n    type: \"website\",\n    locale: \"en_US\",\n    url: siteConfig.url,\n    title: siteConfig.name,\n    description: siteConfig.description,", "    title: siteConfig.name,\n    description: siteConfig.description,\n    siteName: siteConfig.name,\n    images: [\n      {\n        url: siteConfig.ogImageUrl,\n        width: 1240,\n        height: 620,\n        alt: siteConfig.name,\n      },", "        alt: siteConfig.name,\n      },\n    ],\n  },\n  twitter: {\n    card: \"summary_large_image\",\n    title: siteConfig.name,\n    description: siteConfig.description,\n    images: [siteConfig.ogImageUrl],\n    creator: \"@riadazz\",", "    images: [siteConfig.ogImageUrl],\n    creator: \"@riadazz\",\n  },\n  robots: {\n    index: false,\n    follow: true,\n    nocache: true,\n    googleBot: {\n      index: true,\n      follow: false,", "      index: true,\n      follow: false,\n      noimageindex: true,\n      \"max-video-preview\": -1,\n      \"max-image-preview\": \"large\",\n      \"max-snippet\": -1,\n    },\n  },\n  icons: {\n    icon: \"/favicon.ico\",", "  icons: {\n    icon: \"/favicon.ico\",\n    shortcut: \"/images/favicon-32x32.png\",\n    apple: \"/images/apple-touch-icon.png\",\n  },\n  manifest: \"/site.webmanifest\",\n};\n"]}
{"filename": "src/lib/rate-limiter.ts", "chunked_list": ["import { Ratelimit } from \"@upstash/ratelimit\";\nimport { Redis } from \"@upstash/redis\";\nimport { getClientIp } from \"./utils\";\nimport { NextRequest } from \"next/server\";\nimport {\n  upstashToken,\n  upstashUrl,\n  enableUpstash,\n  upstashBanEnabled,\n  upstashBanDuration,", "  upstashBanEnabled,\n  upstashBanDuration,\n  maxRequests,\n  requestsWindow,\n} from \"@/configs/upstash\";\n\nconst isValidUpstash = () => {\n  if (!upstashUrl) {\n    console.error(\"UPSTASH_URL is missing from your environment variables.\");\n  }\n", "  if (!upstashToken) {\n    console.error(\"UPSTASH_TOKEN is missing from your environment variables.\");\n  }\n\n  return upstashUrl !== \"\" && upstashToken != \"\";\n};\n\nexport const redisClient = new Redis({\n  url: upstashUrl,\n  token: upstashToken,\n});\n\nexport const ratelimit = new Ratelimit({\n  redis: redisClient,\n  limiter: Ratelimit.slidingWindow(maxRequests, requestsWindow),\n});\n\nexport const isRatelimited = async (request: NextRequest) => {", "  if (!enableUpstash) return false;\n\n  // Check if upstash variables are set correctly\n  const validUpstash = isValidUpstash();\n  if (!validUpstash) return false;\n\n  try {\n    const identifier = getClientIp(request);\n    if (!identifier) return false;\n    const result = await ratelimit.limit(identifier);\n    if (result.success) return false;\n    // Ban user if ratelimit exceeded", "    if (!identifier) return false;\n    const result = await ratelimit.limit(identifier);\n    if (result.success) return false;\n    // Ban user if ratelimit exceeded\n    if (upstashBanEnabled) {\n      await redisClient.setex(\n        `ban:${identifier}`,\n        upstashBanDuration,\n        \"banned\"\n      );\n    }\n    return true;", "  } catch (error: any) {\n    console.error(error.message);\n    return false;\n  }\n};\n"]}
{"filename": "src/lib/utils.ts", "chunked_list": ["import axios, { AxiosError, AxiosResponse, AxiosRequestConfig } from \"axios\";\nimport { NextRequest } from \"next/server\";\nimport { APIResponse, ErrorResponse, SuccessResponse } from \"@/types\";\nimport { BadRequest } from \"@/exceptions\";\n\nconst userAgents = [\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/17.17134\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/18.17763\",", "  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/17.17134\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/18.17763\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/19\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 OPR/45\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 OPR/46\",\n  \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 OPR/47\",\n];\n\nexport const getRandomUserAgent = () => {\n  return userAgents[Math.floor(Math.random() * userAgents.length)];", "export const getRandomUserAgent = () => {\n  return userAgents[Math.floor(Math.random() * userAgents.length)];\n};\n\nexport const getStrTimestamp = () => Math.floor(Date.now() / 1000).toString();\n\nexport const getTimedFilename = (name: string, ext: string) => {\n  return `${name}-${getStrTimestamp()}.${ext}`;\n};\n", "};\n\nexport const isJsonResponse = (response: Response) => {\n  const contentType = response.headers.get(\"content-type\");\n  return contentType && contentType.includes(\"application/json\");\n};\n\nexport const getClientIp = (request: NextRequest) => {\n  let ip = request.ip ?? request.headers.get(\"x-real-ip\");\n  const forwardedFor = request.headers.get(\"x-forwarded-for\");\n  if (!ip && forwardedFor) {\n    ip = forwardedFor.split(\",\").at(0) ?? null;\n    return ip;\n  }\n  return ip;\n};\n\nexport const getHeaders = () => {\n  const headers = {\n    Accept: \"*/*\",\n    \"Accept-Language\": \"en-us,en;q=0.5\",\n    \"Sec-Fetch-Mode\": \"navigate\",\n    Referer: \"https://www.instagram.com/\",\n    Origin: \"https://www.instagram.com\",\n    \"User-Agent\": getRandomUserAgent(),\n  };\n\n  return headers;\n};\n\nexport const makeHttpRequest = async <T>({\n  ...args\n}: AxiosRequestConfig): Promise<APIResponse<T>> => {", "  let ip = request.ip ?? request.headers.get(\"x-real-ip\");\n  const forwardedFor = request.headers.get(\"x-forwarded-for\");\n  if (!ip && forwardedFor) {\n    ip = forwardedFor.split(\",\").at(0) ?? null;\n    return ip;\n  }\n  return ip;\n};\n\nexport const getHeaders = () => {\n  const headers = {\n    Accept: \"*/*\",\n    \"Accept-Language\": \"en-us,en;q=0.5\",\n    \"Sec-Fetch-Mode\": \"navigate\",\n    Referer: \"https://www.instagram.com/\",\n    Origin: \"https://www.instagram.com\",\n    \"User-Agent\": getRandomUserAgent(),\n  };\n\n  return headers;\n};\n\nexport const makeHttpRequest = async <T>({\n  ...args\n}: AxiosRequestConfig): Promise<APIResponse<T>> => {", "  try {\n    const response: AxiosResponse = await axios(args);\n\n    const successResponse = makeSuccessResponse<T>(response.data);\n    return successResponse;\n  } catch (error: any) {\n    const axiosError: AxiosError = error;\n    if (axiosError.response) {\n      return makeErrorResponse(axiosError.message);\n    } else if (axiosError.request) {\n      console.log(\"Request Error:\", axiosError.request);\n      return makeErrorResponse(\"Request timeout, please try again.\");\n    } else {\n      console.log(\"Error:\", axiosError.message);\n      return makeErrorResponse(\"Something went wrong, please try again.\");\n    }\n  }\n};\n\nexport const makeSuccessResponse = <T>(data: any) => {\n  const response: SuccessResponse<T> = {\n    status: \"success\",\n    data: data,\n  };\n  return response;\n};\n\nexport const makeErrorResponse = (\n  message: string = \"Internal Server Error\"\n) => {\n  const response: ErrorResponse = {\n    status: \"error\",\n    message: message,\n  };\n  return response;\n};\n", "    } else if (axiosError.request) {\n      console.log(\"Request Error:\", axiosError.request);\n      return makeErrorResponse(\"Request timeout, please try again.\");\n    } else {\n      console.log(\"Error:\", axiosError.message);\n      return makeErrorResponse(\"Something went wrong, please try again.\");\n    }\n  }\n};\n\nexport const makeSuccessResponse = <T>(data: any) => {\n  const response: SuccessResponse<T> = {\n    status: \"success\",\n    data: data,\n  };\n  return response;\n};\n\nexport const makeErrorResponse = (\n  message: string = \"Internal Server Error\"\n) => {\n  const response: ErrorResponse = {\n    status: \"error\",\n    message: message,\n  };\n  return response;\n};\n"]}
{"filename": "src/lib/instagram/instagramAPI.ts", "chunked_list": ["import { VideoInfo } from \"@/types\";\nimport { InstaAPIResponse } from \"@/types/instagramAPI\";\n\nimport { makeHttpRequest, getHeaders, getTimedFilename } from \"@/lib/utils\";\nimport { BadRequest } from \"@/exceptions\";\n\nimport { enableGuestApi } from \"@/configs/instagram\";\n\nconst formatGuestJson = (json: InstaAPIResponse) => {\n  const postJson = json.graphql.shortcode_media;", "const formatGuestJson = (json: InstaAPIResponse) => {\n  const postJson = json.graphql.shortcode_media;\n\n  if (!postJson.is_video) {\n    throw new BadRequest(\"This post does not contain a video\", 400);\n  }\n\n  const filename = getTimedFilename(\"instagram-saver\", \"mp4\");\n\n  const videoJson: VideoInfo = {\n    filename: filename,\n    width: postJson.dimensions.width.toString(),\n    height: postJson.dimensions.height.toString(),\n    videoUrl: postJson.video_url,\n  };\n\n  return videoJson;\n};\n\nexport const fetchAsGuest = async (postUrl: string, timeout: number = 0) => {", "  if (!enableGuestApi) {\n    console.log(\"Instagram Guest API is disabled in @config/instagram\");\n    return null;\n  }\n\n  if (!postUrl) return null;\n\n  const headers = getHeaders();\n\n  const apiUrl = postUrl + \"/?__a=1&__d=dis\";\n  const response = await makeHttpRequest<InstaAPIResponse>({\n    url: apiUrl,\n    method: \"GET\",\n    headers,\n    timeout,\n  });\n", "  if (response.status === \"error\") {\n    console.log(response.message);\n    if (response.message.includes(\"status code 404\")) {\n      throw new BadRequest(\n        \"This post does not exist, make sure the URL is correct\"\n      );\n    }\n    return null;\n  }\n\n  const json: InstaAPIResponse = response.data;\n", "  if (json.require_login) {\n    console.log(\"Guest graphql got rate limited by Instagram API\");\n    return null;\n  }\n\n  if (!json.graphql) {\n    console.log(\"Instagram Guest API response has been modified\");\n    return null;\n  }\n\n  const formattedJson = formatGuestJson(json);\n  return formattedJson;\n};\n\nexport const fetchFromAPI = async (postUrl: string, timeout: number = 0) => {\n  const jsonAsGuest = await fetchAsGuest(postUrl, timeout);", "  if (jsonAsGuest) return jsonAsGuest;\n\n  return null;\n};\n"]}
{"filename": "src/lib/instagram/instagramScraper.ts", "chunked_list": ["import { load } from \"cheerio\";\n\nimport { VideoInfo } from \"@/types\";\nimport { PostJson } from \"@/types/instagramScraper\";\n\nimport { makeHttpRequest, getHeaders, getTimedFilename } from \"@/lib/utils\";\nimport { BadRequest } from \"@/exceptions\";\nimport { enableScraper } from \"@/configs/instagram\";\n\nconst formatPageJson = (json: any) => {", "\nconst formatPageJson = (json: any) => {\n  let scrapedPost: PostJson;\n\n  if (Array.isArray(json)) {\n    scrapedPost = json.find((item: any) => item.video);\n  } else {\n    scrapedPost = json;\n  }\n\n  if (!scrapedPost) {\n    return null;\n  }\n\n  const videoList = scrapedPost.video;\n", "  if (!scrapedPost) {\n    return null;\n  }\n\n  const videoList = scrapedPost.video;\n\n  if (!videoList) {\n    throw new BadRequest(\"This post does not contain a video\");\n  }\n\n  if (videoList.length === 0) {\n    throw new BadRequest(\"This post does not contain a video\");\n  }\n\n  const video = videoList[0];\n\n  const filename = getTimedFilename(\"instagram-saver\", \"mp4\");\n\n  const videoJson: VideoInfo = {\n    filename: filename,\n    width: video.width,\n    height: video.height,\n    videoUrl: video.contentUrl,\n  };\n\n  return videoJson;\n};\n\nexport const fetchFromPage = async (postUrl: string, timeout: number = 0) => {\n  const headers = getHeaders();\n", "  if (videoList.length === 0) {\n    throw new BadRequest(\"This post does not contain a video\");\n  }\n\n  const video = videoList[0];\n\n  const filename = getTimedFilename(\"instagram-saver\", \"mp4\");\n\n  const videoJson: VideoInfo = {\n    filename: filename,\n    width: video.width,\n    height: video.height,\n    videoUrl: video.contentUrl,\n  };\n\n  return videoJson;\n};\n\nexport const fetchFromPage = async (postUrl: string, timeout: number = 0) => {\n  const headers = getHeaders();\n", "  if (!enableScraper) {\n    console.log(\"Instagram Scraper is disabled in @config/instagram\");\n    return null;\n  }\n\n  const response = await makeHttpRequest<string>({\n    url: postUrl,\n    method: \"GET\",\n    headers,\n    timeout,\n  });\n", "  if (response.status === \"error\") {\n    console.log(response.message);\n    if (response.message.includes(\"status code 404\")) {\n      throw new BadRequest(\n        \"This post does not exist, make sure the URL is correct\"\n      );\n    }\n    return null;\n  }\n\n  const $ = load(response.data);\n  const jsonElement = $(\"script[type='application/ld+json']\");\n", "  if (jsonElement.length === 0) {\n    console.log(\"LD+JSON not available for this post\");\n    return null;\n  }\n\n  const jsonText: string = jsonElement.text();\n  const json: any = JSON.parse(jsonText);\n  const formattedJson = formatPageJson(json);\n  return formattedJson;\n};\n"]}
{"filename": "src/lib/instagram/actions.ts", "chunked_list": ["\"use server\";\n\nimport { Exception } from \"@/exceptions\";\nimport { getPostId, fetchPostJson } from \"@/lib/instagram\";\nimport { makeErrorResponse, makeSuccessResponse } from \"../utils\";\nimport { VideoInfo } from \"@/types\";\n\nfunction handleError(error: any) {\n  if (error instanceof Exception) {\n    return makeErrorResponse(error.message);\n  } else {\n    console.error(error);\n    return makeErrorResponse();\n  }\n}\n", "  if (error instanceof Exception) {\n    return makeErrorResponse(error.message);\n  } else {\n    console.error(error);\n    return makeErrorResponse();\n  }\n}\n\nexport async function fetchVideoInfoAction(postUrl: string) {\n  let postId;\n", "export async function fetchVideoInfoAction(postUrl: string) {\n  let postId;\n\n  try {\n    postId = getPostId(postUrl);\n  } catch (error: any) {\n    return handleError(error);\n  }\n\n  try {\n    const videoInfo = await fetchPostJson(postId);\n    const response = makeSuccessResponse<VideoInfo>(videoInfo);\n    return response;", "  try {\n    const videoInfo = await fetchPostJson(postId);\n    const response = makeSuccessResponse<VideoInfo>(videoInfo);\n    return response;\n  } catch (error: any) {\n    return handleError(error);\n  }\n}\n"]}
{"filename": "src/lib/instagram/index.ts", "chunked_list": ["import { BadRequest } from \"@/exceptions\";\n\nimport { fetchFromAPI } from \"./instagramAPI\";\nimport { fetchFromPage } from \"./instagramScraper\";\n\nexport const getPostId = (postUrl: string | null) => {\n  const postRegex =\n    /^https:\\/\\/(?:www\\.)?instagram\\.com\\/p\\/([a-zA-Z0-9_-]+)\\/?/;\n  const reelRegex =\n    /^https:\\/\\/(?:www\\.)?instagram\\.com\\/reels?\\/([a-zA-Z0-9_-]+)\\/?/;", "  const reelRegex =\n    /^https:\\/\\/(?:www\\.)?instagram\\.com\\/reels?\\/([a-zA-Z0-9_-]+)\\/?/;\n  let postId;\n\n  if (!postUrl) {\n    throw new BadRequest(\"Instagram URL was not provided\");\n  }\n\n  const postCheck = postUrl.match(postRegex);\n  if (postCheck) {\n    postId = postCheck.at(-1);\n  }\n\n  const reelCheck = postUrl.match(reelRegex);", "  if (postCheck) {\n    postId = postCheck.at(-1);\n  }\n\n  const reelCheck = postUrl.match(reelRegex);\n  if (reelCheck) {\n    postId = reelCheck.at(-1);\n  }\n\n  if (!postId) {\n    throw new BadRequest(\"Instagram post/reel ID was not found\");\n  }\n\n  return postId;\n};\n\nexport const fetchPostJson = async (postID: string, timeout?: number) => {\n  const postUrl = \"https://www.instagram.com/p/\" + postID;\n\n  const pageJson = await fetchFromPage(postUrl, timeout);", "  if (!postId) {\n    throw new BadRequest(\"Instagram post/reel ID was not found\");\n  }\n\n  return postId;\n};\n\nexport const fetchPostJson = async (postID: string, timeout?: number) => {\n  const postUrl = \"https://www.instagram.com/p/\" + postID;\n\n  const pageJson = await fetchFromPage(postUrl, timeout);", "  if (pageJson) return pageJson;\n\n  const apiJson = await fetchFromAPI(postUrl, timeout);\n  if (apiJson) return apiJson;\n\n  throw new BadRequest(\n    \"The video download link for this post is not available.\",\n    401\n  );\n};\n"]}
{"filename": "src/exceptions/index.ts", "chunked_list": ["export class Exception extends Error {\n  code: number;\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Instagram Exception\", code = 500) {\n    super(message);\n    this.code = code;\n  }\n}\n\n/* Server Exceptions */\n", "export class BadRequest extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Bad Request\", code = 400) {\n    super(message, code);\n  }\n}\n\nexport class ServerException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Internal Server Error\", code = 500) {\n    super(message, code);\n  }\n}\n", "export class ServerException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Internal Server Error\", code = 500) {\n    super(message, code);\n  }\n}\n\nexport class TimeoutException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Request timeout, please try again.\", code = 408) {\n    super(message, code);\n  }\n}\n", "export class TimeoutException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Request timeout, please try again.\", code = 408) {\n    super(message, code);\n  }\n}\n\nexport class RatelimitException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Too many requests, try again later.\", code = 429) {\n    super(message, code);\n  }\n}\n\n/* Client Exceptions */\n", "export class RatelimitException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Too many requests, try again later.\", code = 429) {\n    super(message, code);\n  }\n}\n\n/* Client Exceptions */\n", "export class ClientException extends Exception {\n  /**\n   * @param message\n   * @param code\n   */\n  constructor(message = \"Instagram Client Exception\", code = 400) {\n    super(message, code);\n  }\n}\n"]}
{"filename": "src/types/instagramAPI.ts", "chunked_list": ["export type InstaAPIResponse = {\n  require_login?: boolean;\n  graphql: {\n    shortcode_media: {\n      __typename: string;\n      id: string;\n      shortcode: string;\n      dimensions: {\n        height: number;\n        width: number;\n      };\n      gating_info: any;\n      fact_check_overall_rating: any;\n      fact_check_information: any;\n      sensitivity_friction_info: any;\n      sharing_friction_info: {\n        should_have_sharing_friction: boolean;\n        bloks_app_url: any;\n      };\n      media_overlay_info: any;\n      media_preview: string;\n      display_url: string;\n      display_resources: Array<{\n        src: string;\n        config_width: number;\n        config_height: number;\n      }>;\n      accessibility_caption: any;\n      dash_info: {\n        is_dash_eligible: boolean;\n        video_dash_manifest: any;\n        number_of_qualities: number;\n      };\n      has_audio: boolean;\n      video_url: string;\n      video_view_count: number;\n      video_play_count: number;\n      is_video: boolean;\n      tracking_token: string;\n      upcoming_event: any;\n      edge_media_to_tagged_user: {\n        edges: Array<any>;\n      };\n      edge_media_to_caption: {\n        edges: Array<{\n          node: {\n            created_at: string;\n            text: string;\n          };\n        }>;\n      };\n      can_see_insights_as_brand: boolean;\n      caption_is_edited: boolean;\n      has_ranked_comments: boolean;\n      like_and_view_counts_disabled: boolean;\n      edge_media_to_parent_comment: {\n        count: number;\n        page_info: {\n          has_next_page: boolean;\n          end_cursor: string;\n        };\n        edges: Array<{\n          node: {\n            id: string;\n            text: string;\n            created_at: number;\n            did_report_as_spam: boolean;\n            owner: {\n              id: string;\n              is_verified: boolean;\n              profile_pic_url: string;\n              username: string;\n            };\n            viewer_has_liked: boolean;\n            edge_liked_by: {\n              count: number;\n            };\n            is_restricted_pending: boolean;\n            edge_threaded_comments: {\n              count: number;\n              page_info: {\n                has_next_page: boolean;\n                end_cursor: any;\n              };\n              edges: Array<any>;\n            };\n          };\n        }>;\n      };\n      edge_media_to_hoisted_comment: {\n        edges: Array<any>;\n      };\n      edge_media_preview_comment: {\n        count: number;\n        edges: Array<{\n          node: {\n            id: string;\n            text: string;\n            created_at: number;\n            did_report_as_spam: boolean;\n            owner: {\n              id: string;\n              is_verified: boolean;\n              profile_pic_url: string;\n              username: string;\n            };\n            viewer_has_liked: boolean;\n            edge_liked_by: {\n              count: number;\n            };\n            is_restricted_pending: boolean;\n          };\n        }>;\n      };\n      comments_disabled: boolean;\n      commenting_disabled_for_viewer: boolean;\n      taken_at_timestamp: number;\n      edge_media_preview_like: {\n        count: number;\n        edges: Array<any>;\n      };\n      edge_media_to_sponsor_user: {\n        edges: Array<any>;\n      };\n      is_affiliate: boolean;\n      is_paid_partnership: boolean;\n      location: any;\n      nft_asset_info: any;\n      viewer_has_liked: boolean;\n      viewer_has_saved: boolean;\n      viewer_has_saved_to_collection: boolean;\n      viewer_in_photo_of_you: boolean;\n      viewer_can_reshare: boolean;\n      owner: {\n        id: string;\n        is_verified: boolean;\n        profile_pic_url: string;\n        username: string;\n        blocked_by_viewer: boolean;\n        restricted_by_viewer: any;\n        followed_by_viewer: boolean;\n        full_name: string;\n        has_blocked_viewer: boolean;\n        is_embeds_disabled: boolean;\n        is_private: boolean;\n        is_unpublished: boolean;\n        requested_by_viewer: boolean;\n        pass_tiering_recommendation: boolean;\n        edge_owner_to_timeline_media: {\n          count: number;\n        };\n        edge_followed_by: {\n          count: number;\n        };\n      };\n      is_ad: boolean;\n      edge_web_media_to_related_media: {\n        edges: Array<any>;\n      };\n      coauthor_producers: Array<any>;\n      pinned_for_users: Array<any>;\n      encoding_status: any;\n      is_published: boolean;\n      product_type: string;\n      title: string;\n      video_duration: number;\n      thumbnail_src: string;\n      clips_music_attribution_info: {\n        artist_name: string;\n        song_name: string;\n        uses_original_audio: boolean;\n        should_mute_audio: boolean;\n        should_mute_audio_reason: string;\n        audio_id: string;\n      };\n      edge_related_profiles: {\n        edges: Array<{\n          node: {\n            id: string;\n            full_name: string;\n            is_private: boolean;\n            is_verified: boolean;\n            profile_pic_url: string;\n            username: string;\n            edge_followed_by: {\n              count: number;\n            };\n            edge_owner_to_timeline_media: {\n              count: number;\n              edges: Array<{\n                node: {\n                  __typename: string;\n                  id: string;\n                  shortcode: string;\n                  edge_media_preview_like: {\n                    count: number;\n                  };\n                  edge_media_preview_comment: {\n                    count: number;\n                  };\n                  thumbnail_src: string;\n                  owner: {\n                    id: string;\n                    username: string;\n                  };\n                  gating_info: any;\n                  sharing_friction_info: {\n                    should_have_sharing_friction: boolean;\n                    bloks_app_url: any;\n                  };\n                  media_overlay_info: any;\n                  is_video: boolean;\n                  accessibility_caption: any;\n                };\n              }>;\n            };\n          };\n        }>;\n      };\n    };\n  };\n  showQRModal: boolean;\n};\n"]}
{"filename": "src/types/instagramScraper.ts", "chunked_list": ["export type PostJson = {\n  articleBody: string;\n  author: {\n    \"@type\": string;\n    identifier: {\n      \"@type\": string;\n      propertyID: string;\n      value: string;\n    };\n    image: string;\n    name: string;\n    alternateName: string;\n    url: string;\n  };\n  comment: {\n    \"@type\": string;\n    text: string;\n    author: {\n      \"@type\": string;\n      identifier: {\n        \"@type\": string;\n        propertyID: string;\n        value: string;\n      };\n      image: string;\n      name: string;\n      alternateName: string;\n      url: string;\n    };\n    dateCreated: string;\n    interactionStatistic: {\n      \"@type\": string;\n      interactionType: string;\n      userInteractionCount: number;\n    };\n  };\n  commentCount: string;\n  contentLocation: any;\n  \"@context\": string;\n  dateCreated: string;\n  dateModified: string;\n  headline: string;\n  identifier: {\n    \"@type\": string;\n    propertyID: string;\n    value: string;\n  };\n  image: Array<any>;\n  interactionStatistic: Array<{\n    \"@type\": string;\n    interactionType: string;\n    userInteractionCount: number;\n  }>;\n  mainEntityOfPage: {\n    \"@type\": string;\n    \"@id\": string;\n  };\n  \"@type\": string;\n  video: Array<{\n    \"@type\": string;\n    uploadDate: string;\n    description: string;\n    name: string;\n    caption: string;\n    height: string;\n    width: string;\n    contentUrl: string;\n    thumbnailUrl: string;\n    genre: Array<any>;\n    keywords: Array<any>;\n    interactionStatistic: Array<{\n      \"@type\": string;\n      interactionType: string;\n      userInteractionCount: number;\n    }>;\n  }>;\n};\n"]}
{"filename": "src/types/index.ts", "chunked_list": ["export type SuccessResponse<T> = {\n  status: \"success\";\n  data: T;\n};\n\nexport type ErrorResponse = {\n  status: \"error\";\n  message: string;\n};\n\nexport type APIResponse<T> = SuccessResponse<T> | ErrorResponse;\n", "export type APIResponse<T> = SuccessResponse<T> | ErrorResponse;\n\nexport type SiteConfig = {\n  name: string;\n  description: string;\n  url: string;\n  ogImageUrl: string;\n  links: {\n    twitter: string;\n    github: string;\n  };\n};\n", "export type VideoInfo = {\n  filename: string;\n  width: string;\n  height: string;\n  videoUrl: string;\n};\n"]}
{"filename": "src/__tests__/instagram.test.ts", "chunked_list": ["import { BadRequest, TimeoutException } from \"@/exceptions\";\nimport { fetchPostJson, getPostId } from \"@/lib/instagram\";\n\n// URL for post page with ld+json included\nconst postUrl = \"https://www.instagram.com/p/CGh4a0iASGS\";\nconst postId = \"CGh4a0iASGS\";\n\n// Check if getPostId function is working\ndescribe(\"success-getPostId\", () => {\n  it(\"should return a postId from the postUrl\", () => {\n    const testPostId = getPostId(postUrl);\n    expect(testPostId).toBe(postId);\n  });\n});\n\ndescribe(\"fail-getPostId\", () => {\n  it(\"should throw BadRequest error\", () => {\n    const invalidPostUrl = \"https://www.doesnt-exist.com/p/CrYKenNJeey/\";\n    expect(() => {\n      getPostId(invalidPostUrl);\n    }).toThrow(BadRequest);\n  });\n});\n", "// Check if fetchPostJson function is working\ndescribe(\"success-fetchPostJson\", () => {\n  it(\"should return a VideoJson object\", async () => {\n    const response = await fetchPostJson(postId);\n    expect(response?.videoUrl).toBeDefined();\n  });\n});\n\ndescribe(\"timeout-fetchPostJson\", () => {\n  it(\"should throw TimeoutException error\", async () => {\n    try {\n      // Set timeout of 1ms to force timeout error\n      await fetchPostJson(postId, 1);", "    try {\n      // Set timeout of 1ms to force timeout error\n      await fetchPostJson(postId, 1);\n    } catch (error) {\n      expect(error instanceof TimeoutException).toBe(true);\n    }\n  });\n});\n"]}
{"filename": "src/__tests__/instagramScraper.test.ts", "chunked_list": ["import { BadRequest } from \"@/exceptions\";\nimport { fetchFromPage } from \"@/lib/instagram/instagramScraper\";\n\n// Url for post page with ld+json include\nconst postUrl = \"https://www.instagram.com/p/CGh4a0iASGS\";\n// Url for post page that does not contain a video\nconst imagePostUrl = \"https://www.instagram.com/p/CpldyYgvdhz\";\n\n// Check if the page json scraper is working\ndescribe(\"success-fetchFromPage\", () => {", "// Check if the page json scraper is working\ndescribe(\"success-fetchFromPage\", () => {\n  it(\"should return a VideoJson object\", async () => {\n    const response = await fetchFromPage(postUrl);\n    expect(response?.videoUrl).toBeDefined();\n  });\n});\n\ndescribe(\"no-video-fetchFromPage\", () => {\n  it(\"should throw IGBadRequest error\", async () => {\n    try {\n      await fetchFromPage(imagePostUrl);", "describe(\"no-video-fetchFromPage\", () => {\n  it(\"should throw IGBadRequest error\", async () => {\n    try {\n      await fetchFromPage(imagePostUrl);\n    } catch (error) {\n      expect(error instanceof BadRequest).toBe(true);\n    }\n  });\n});\n"]}
{"filename": "src/__tests__/instagramAPI.test.ts", "chunked_list": ["import { BadRequest } from \"@/exceptions\";\nimport { fetchFromAPI } from \"@/lib/instagram/instagramAPI\";\n\n// URL for post page with no ld+json included\nconst postUrl = \"https://www.instagram.com/p/CrYKenNJeey\";\n// Url for post page that does not contain a video\nconst imagePostUrl = \"https://www.instagram.com/p/CpldyYgvdhz\";\n\n// Check if the Instagram API is working\ndescribe(\"success-fetchFromAPI\", () => {", "// Check if the Instagram API is working\ndescribe(\"success-fetchFromAPI\", () => {\n  it(\"should return VideoJson object\", async () => {\n    const response = await fetchFromAPI(postUrl);\n    expect(response?.videoUrl).toBeDefined();\n  });\n});\n\ndescribe(\"no-video-fetchFromAPI\", () => {\n  it(\"should throw BadRequest error\", async () => {", "describe(\"no-video-fetchFromAPI\", () => {\n  it(\"should throw BadRequest error\", async () => {\n    await expect(fetchFromAPI(imagePostUrl)).rejects.toThrow(BadRequest);\n  });\n});\n"]}
{"filename": "src/__tests__/ratelimit.test.ts", "chunked_list": ["// Check if the environment variables are defined\ndescribe(\"upstash-env-variables\", () => {\n  it(\"should have a USE_UPSTASH variable\", () => {\n    expect(process.env.USE_UPSTASH).toBeDefined();\n  });\n\n  it(\"should have a UPSTASH_URL variable\", () => {\n    expect(process.env.UPSTASH_URL).toBeDefined();\n  });\n", "  });\n\n  it(\"should have a UPSTASH_TOKEN variable\", () => {\n    expect(process.env.UPSTASH_TOKEN).toBeDefined();\n  });\n});\n"]}
{"filename": "src/app/api/instagram/route.ts", "chunked_list": ["import { NextResponse } from \"next/server\";\nimport { Exception } from \"@/exceptions\";\nimport { getPostId, fetchPostJson } from \"@/lib/instagram\";\nimport { enableServerAPI } from \"@/configs/instagram\";\nimport { makeErrorResponse, makeSuccessResponse } from \"@/lib/utils\";\nimport { VideoInfo } from \"@/types\";\n\nfunction handleError(error: any) {\n  if (error instanceof Exception) {\n    const response = makeErrorResponse(error.message);\n    return NextResponse.json(response, { status: error.code });\n  } else {\n    console.error(error);\n    const response = makeErrorResponse();\n    return NextResponse.json(response, { status: 500 });\n  }\n}\n", "  if (error instanceof Exception) {\n    const response = makeErrorResponse(error.message);\n    return NextResponse.json(response, { status: error.code });\n  } else {\n    console.error(error);\n    const response = makeErrorResponse();\n    return NextResponse.json(response, { status: 500 });\n  }\n}\n\nexport async function GET(request: Request) {", "export async function GET(request: Request) {\n  if (!enableServerAPI) {\n    return NextResponse.json({ error: \"Not Implemented\" }, { status: 501 });\n  }\n\n  const { searchParams } = new URL(request.url);\n  const url: string | null = searchParams.get(\"url\");\n  let postId;\n\n  try {\n    postId = getPostId(url);", "  try {\n    postId = getPostId(url);\n  } catch (error: any) {\n    return handleError(error);\n  }\n\n  try {\n    const postJson = await fetchPostJson(postId);\n    const response = makeSuccessResponse<VideoInfo>(postJson);\n    return NextResponse.json(response, { status: 200 });\n  } catch (error: any) {\n    return handleError(error);\n  }\n}\n", "  } catch (error: any) {\n    return handleError(error);\n  }\n}\n"]}
